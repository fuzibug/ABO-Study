<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABO Mock Exam</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#080c16;--s1:#0f1624;--s2:#161f30;--s3:#1c2740;--bdr:rgba(99,179,237,0.13);--acc:#63b3ed;--acc2:#4299e1;--gold:#d4a853;--tx:#e2e8f0;--tx2:#8a9ab5;--mut:#3d4f66;--ok:#68d391;--bad:#fc8181;--wrn:#f6ad55;--h1a:#e2e8f0;--h1b:#63b3ed;--h1c:#f6ad55;--gl:rgba(99,179,237,.018);}
body.theme-emerald{--bg:#081610;--s1:#0d1f14;--s2:#122a1a;--s3:#183524;--bdr:rgba(72,187,120,.13);--acc:#48bb78;--acc2:#38a169;--tx:#e6ffed;--tx2:#7fb896;--mut:#2d5040;--h1a:#e6ffed;--h1b:#48bb78;--h1c:#f6ad55;--gl:rgba(72,187,120,.018);}
body.theme-crimson{--bg:#160810;--s1:#1f0d16;--s2:#2a1220;--s3:#38172d;--bdr:rgba(245,101,101,.13);--acc:#f56565;--acc2:#e53e3e;--tx:#fff5f5;--tx2:#c07080;--mut:#5a2540;--h1a:#fff5f5;--h1b:#f56565;--h1c:#f6ad55;--gl:rgba(245,101,101,.018);}
body.theme-violet{--bg:#0d0816;--s1:#150f24;--s2:#1e1530;--s3:#271c3d;--bdr:rgba(159,122,234,.13);--acc:#9f7aea;--acc2:#805ad5;--tx:#faf5ff;--tx2:#917cbc;--mut:#4a3566;--h1a:#faf5ff;--h1b:#9f7aea;--h1c:#f6ad55;--gl:rgba(159,122,234,.018);}
body.theme-clinical{--bg:#f0f4f8;--s1:#ffffff;--s2:#edf2f7;--s3:#e2e8f0;--bdr:rgba(49,130,206,.15);--acc:#3182ce;--acc2:#2b6cb0;--gold:#c27c1a;--tx:#1a202c;--tx2:#4a5568;--mut:#a0aec0;--ok:#276749;--bad:#c53030;--wrn:#c05621;--h1a:#1a202c;--h1b:#3182ce;--h1c:#c27c1a;--gl:rgba(49,130,206,.04);}
body.theme-slate{--bg:#0f1117;--s1:#1a1d27;--s2:#22263a;--s3:#2a2f47;--bdr:rgba(160,174,192,.12);--acc:#a0aec0;--acc2:#718096;--tx:#edf2f7;--tx2:#718096;--mut:#4a5568;--h1a:#edf2f7;--h1b:#a0aec0;--h1c:#d4a853;--gl:rgba(160,174,192,.015);}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--tx);font-family:"DM Sans",sans-serif;min-height:100vh;transition:background .3s,color .3s;}
body::after{content:"";position:fixed;inset:0;background:linear-gradient(var(--gl) 1px,transparent 1px),linear-gradient(90deg,var(--gl) 1px,transparent 1px);background-size:60px 60px;pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:32px 20px 80px;}
.hdr{text-align:center;margin-bottom:32px;}
.badge{display:inline-block;font-family:"DM Mono",monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);border:1px solid rgba(212,168,83,.3);padding:5px 16px;border-radius:2px;margin-bottom:14px;}
h1{font-family:"Playfair Display",serif;font-size:clamp(2rem,5vw,3rem);font-weight:900;background:linear-gradient(135deg,var(--h1a),var(--h1b) 50%,var(--h1c));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px;}
.sub{color:var(--tx2);font-size:13px;}
.card{background:var(--s1);border:1px solid var(--bdr);border-radius:12px;padding:24px;margin-bottom:14px;}
.ctitle{font-family:"DM Mono",monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:16px;}
.page{display:none;}.page.show{display:block;}
.tabs{display:flex;gap:4px;background:var(--s1);border:1px solid var(--bdr);border-radius:10px;padding:4px;margin-bottom:20px;}
.tab{flex:1;padding:9px;background:none;border:none;color:var(--tx2);font-family:"DM Sans",sans-serif;font-size:11px;font-weight:500;cursor:pointer;border-radius:7px;transition:.15s;}
.tab:hover{background:var(--s2);color:var(--tx);}
.tab.on{background:var(--s3);color:var(--acc);border:1px solid var(--bdr);}
.tog{position:relative;display:inline-block;width:48px;height:26px;flex-shrink:0;}
.tog input{position:absolute;opacity:0;width:0;height:0;pointer-events:none;}
.tog-track{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--s3);border:1px solid var(--mut);border-radius:13px;transition:.25s;cursor:pointer;}
.tog-track::before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:50%;background:var(--tx2);transition:.25s;}
.tog input:checked+.tog-track{background:rgba(99,179,237,.2);border-color:var(--acc);}
.tog input:checked+.tog-track::before{transform:translateX(22px);background:var(--acc);}
.mode-row{display:flex;align-items:center;gap:16px;padding:16px;background:var(--s2);border:1px solid var(--bdr);border-radius:10px;}
.mode-text{flex:1;min-width:0;}
.mode-label{font-size:14px;font-weight:600;color:var(--tx);}
.mode-sub{font-size:11px;color:var(--tx2);margin-top:3px;}
.tog-wrap{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.tog-lbl{font-family:"DM Mono",monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--tx2);transition:.15s;}
.tog-lbl.active{color:var(--acc);}
.ai-panel{display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--bdr);}
.ai-panel.show{display:block;}
.provider-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.prov-card{background:var(--bg);border:2px solid var(--bdr);border-radius:10px;padding:13px 15px;cursor:pointer;transition:.15s;}
.prov-card:hover{border-color:var(--acc);background:rgba(99,179,237,.05);}
.prov-card.on{border-color:var(--acc);background:rgba(99,179,237,.07);box-shadow:0 0 0 1px var(--acc);}
.prov-name{font-size:14px;font-weight:700;color:var(--tx);}
.prov-tag{display:inline-block;font-family:"DM Mono",monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 7px;border-radius:3px;margin:4px 0;background:rgba(99,179,237,.1);color:var(--acc);border:1px solid rgba(99,179,237,.2);}
.prov-desc{font-size:11px;color:var(--tx2);line-height:1.5;}
.model-section{display:none;}.model-section.show{display:block;}
.models-ctitle{font-family:"DM Mono",monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);margin-bottom:10px;}
.model-list{display:flex;flex-direction:column;gap:7px;margin-bottom:14px;}
.mc{background:var(--bg);border:1px solid var(--bdr);border-radius:10px;padding:12px 14px;cursor:pointer;transition:.15s;display:flex;gap:12px;align-items:flex-start;}
.mc:hover,.mc.on{border-color:var(--acc);background:rgba(99,179,237,.05);}
.mc.on{box-shadow:0 0 0 1px var(--acc);}
.mc-dot{width:9px;height:9px;border-radius:50%;background:var(--mut);flex-shrink:0;margin-top:4px;transition:.15s;}
.mc.on .mc-dot{background:var(--acc);}
.mc-info{flex:1;min-width:0;}
.mc-name{font-size:13px;font-weight:600;color:var(--tx);margin-bottom:3px;}
.mc-badges{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:5px;}
.mbadge{font-family:"DM Mono",monospace;font-size:7px;letter-spacing:.5px;padding:2px 6px;border-radius:3px;text-transform:uppercase;}
.mb-free{background:rgba(104,211,145,.12);color:#68d391;border:1px solid rgba(104,211,145,.25);}
.mb-fast{background:rgba(118,228,247,.12);color:#76e4f7;border:1px solid rgba(118,228,247,.25);}
.mb-smart{background:rgba(212,168,83,.12);color:#d4a853;border:1px solid rgba(212,168,83,.25);}
.mb-paid{background:rgba(252,129,129,.1);color:#fc8181;border:1px solid rgba(252,129,129,.2);}
.mb-reason{background:rgba(183,148,244,.12);color:#b794f4;border:1px solid rgba(183,148,244,.25);}
.mc-why{font-size:11px;color:var(--tx2);line-height:1.55;}
.api-row{display:flex;gap:8px;margin-top:10px;}
.api-input{flex:1;background:var(--bg);border:1px solid var(--bdr);border-radius:7px;color:var(--tx);font-family:"DM Mono",monospace;font-size:12px;padding:9px 12px;outline:none;transition:.15s;}
.api-input:focus{border-color:var(--acc);}
.api-input::placeholder{color:var(--mut);}
.api-save{padding:0 16px;background:rgba(99,179,237,.12);border:1px solid rgba(99,179,237,.3);border-radius:7px;color:var(--acc);font-family:"DM Sans",sans-serif;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.15s;}
.api-save:hover{background:rgba(99,179,237,.22);}
.api-hint{font-size:11px;color:var(--tx2);margin-top:10px;line-height:1.6;}
.api-hint a{color:var(--acc);text-decoration:none;}.api-hint a:hover{text-decoration:underline;}
.api-status{font-size:11px;margin-top:6px;min-height:15px;}
.api-status.ok{color:var(--ok);}.api-status.err{color:var(--bad);}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(143px,1fr));gap:7px;}
.dbtn{background:var(--s2);border:1px solid var(--bdr);border-radius:9px;padding:11px 12px;color:var(--tx2);font-family:"DM Sans",sans-serif;font-size:12px;font-weight:500;cursor:pointer;text-align:left;transition:.15s;width:100%;}
.dbtn:hover,.dbtn.on{border-color:var(--acc);background:rgba(99,179,237,.08);color:var(--tx);}
.di{font-size:16px;margin-bottom:4px;display:block;}.dn{font-size:12px;font-weight:600;}.ds{font-size:10px;color:var(--tx2);margin-top:1px;}
.dfgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(118px,1fr));gap:7px;}
.dfbtn{background:var(--s2);border:1px solid var(--bdr);border-radius:9px;padding:11px 12px;cursor:pointer;text-align:left;transition:.15s;width:100%;}
.dfbtn:hover,.dfbtn.on{border-color:var(--acc);background:rgba(99,179,237,.07);}
.dfbadge{display:inline-block;font-family:"DM Mono",monospace;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;padding:2px 7px;border-radius:3px;margin-bottom:4px;}
.dfname{font-size:13px;font-weight:600;color:var(--tx);}.dfdesc{font-size:10px;color:var(--tx2);margin-top:2px;line-height:1.4;}
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:9px;}
.sbox{background:var(--s2);border:1px solid var(--bdr);border-radius:9px;padding:13px 15px;display:flex;flex-direction:column;gap:9px;}
.slabel{font-family:"DM Mono",monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);display:block;}
.sbox-desc{font-size:10px;color:var(--mut);}
.seg{display:flex;background:var(--bg);border:1px solid var(--bdr);border-radius:6px;overflow:hidden;}
.sgbtn{flex:1;padding:7px 3px;background:none;border:none;color:var(--tx2);font-family:"DM Sans",sans-serif;font-size:11px;cursor:pointer;transition:.15s;}
.sgbtn:hover{color:var(--tx);}.sgbtn.on{background:var(--s3);color:var(--acc);}
.tog-row{display:flex;align-items:center;justify-content:space-between;}
.tog-state{font-size:12px;color:var(--tx2);transition:.15s;}.tog-state.on{color:var(--acc);}
.rng-wrap{display:flex;align-items:center;gap:8px;}
.rng-val{font-family:"DM Mono",monospace;font-size:13px;color:var(--acc);min-width:30px;text-align:right;}
input[type=range]{-webkit-appearance:none;flex:1;height:4px;border-radius:2px;background:var(--bg);outline:none;border:1px solid var(--bdr);}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--acc);cursor:pointer;border:2px solid var(--s2);}
input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--acc);cursor:pointer;border:2px solid var(--s2);}
.theme-swatches{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
.theme-swatch{width:38px;height:38px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:.2s;flex-shrink:0;}
.theme-swatch:hover{transform:scale(1.15);}
.theme-swatch.on{border-color:var(--tx);transform:scale(1.15);}
.theme-label{font-size:11px;color:var(--tx2);margin-top:6px;text-align:center;font-family:"DM Mono",monospace;}
.theme-item{display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;}
.btn-go{width:100%;padding:16px;background:linear-gradient(135deg,var(--acc2),var(--acc));border:1px solid rgba(99,179,237,.4);border-radius:10px;color:#fff;font-family:"DM Sans",sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:.2s;margin-top:4px;}
.btn-go:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(99,179,237,.2);}
.btn-sec{padding:11px 20px;background:transparent;border:1px solid var(--bdr);border-radius:8px;color:var(--tx2);font-family:"DM Sans",sans-serif;font-size:13px;cursor:pointer;transition:.15s;}
.btn-sec:hover{border-color:var(--acc);color:var(--acc);}
.btn-danger{border-color:rgba(252,129,129,.2)!important;color:rgba(252,129,129,.6)!important;}
.btn-danger:hover{border-color:rgba(252,129,129,.5)!important;color:var(--bad)!important;}
.prog{height:3px;background:var(--s2);border-radius:2px;margin-bottom:24px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--gold));border-radius:2px;transition:width .35s;}
.timer-row{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
.tnum{font-family:"DM Mono",monospace;font-size:13px;color:var(--tx2);min-width:32px;text-align:right;}
.tnum.red{color:var(--bad);}
.tbar{flex:1;height:3px;background:var(--s2);border-radius:2px;overflow:hidden;}
.tbar-fill{height:100%;background:linear-gradient(90deg,var(--ok),var(--acc));border-radius:2px;transition:width .95s linear;}
.tbar-fill.red{background:linear-gradient(90deg,var(--bad),var(--wrn));}
.qmeta{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:6px;}
.qnum{font-family:"DM Mono",monospace;font-size:10px;color:var(--tx2);}
.qtags{display:flex;gap:5px;flex-wrap:wrap;}
.qtag{font-family:"DM Mono",monospace;font-size:9px;padding:3px 9px;border-radius:20px;border:1px solid;}
.qt-d{color:var(--gold);background:rgba(212,168,83,.07);border-color:rgba(212,168,83,.22);}
.qt-f{color:var(--ok);background:rgba(104,211,145,.07);border-color:rgba(104,211,145,.22);}
.qt-i{color:var(--wrn);background:rgba(246,173,85,.07);border-color:rgba(246,173,85,.22);}
.qt-a{color:var(--bad);background:rgba(252,129,129,.07);border-color:rgba(252,129,129,.22);}
.qt-e{color:#b794f4;background:rgba(183,148,244,.07);border-color:rgba(183,148,244,.22);}
.qt-off{color:#76e4f7;background:rgba(118,228,247,.07);border-color:rgba(118,228,247,.22);}
.qt-ai{color:#b794f4;background:rgba(183,148,244,.07);border-color:rgba(183,148,244,.22);}
.qtext{font-family:"Playfair Display",serif;font-size:clamp(1rem,2.4vw,1.2rem);line-height:1.65;margin-bottom:22px;color:var(--tx);}
.opts{display:flex;flex-direction:column;gap:8px;}
.opt{background:var(--s2);border:1px solid var(--bdr);border-radius:10px;padding:13px 17px;color:var(--tx);font-family:"DM Sans",sans-serif;font-size:13px;cursor:pointer;text-align:left;transition:.14s;display:flex;align-items:flex-start;gap:12px;line-height:1.5;width:100%;}
.opt:hover:not([disabled]){border-color:var(--acc);background:rgba(99,179,237,.06);transform:translateX(2px);}
.opt[disabled]{cursor:default;}
.opt.ok{background:rgba(104,211,145,.09);border-color:var(--ok);color:var(--ok);}
.opt.bad{background:rgba(252,129,129,.09);border-color:var(--bad);color:var(--bad);}
.opt.missed{background:rgba(104,211,145,.04);border-color:rgba(104,211,145,.35);}
.opt-l{font-family:"DM Mono",monospace;font-size:11px;font-weight:600;color:var(--tx2);background:rgba(113,128,150,.12);width:23px;height:23px;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.opt.ok .opt-l{background:rgba(104,211,145,.18);color:var(--ok);}
.opt.bad .opt-l{background:rgba(252,129,129,.18);color:var(--bad);}
.opt.missed .opt-l{background:rgba(104,211,145,.12);color:var(--ok);}
.opt-k{font-family:"DM Mono",monospace;font-size:9px;color:rgba(113,128,150,.3);margin-left:auto;flex-shrink:0;}
.exp{margin-top:16px;background:rgba(99,179,237,.04);border:1px solid rgba(99,179,237,.14);border-radius:10px;padding:16px;display:none;animation:fadeup .28s ease;}
.exp.show{display:block;}
.exp-lbl{font-family:"DM Mono",monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--acc);margin-bottom:7px;}
.exp-body{font-size:13px;color:var(--tx2);line-height:1.75;}
.exp-src{margin-top:6px;font-family:"DM Mono",monospace;font-size:10px;color:rgba(212,168,83,.55);}
.qfoot{display:flex;justify-content:space-between;align-items:center;margin-top:18px;flex-wrap:wrap;gap:10px;}
.live{font-family:"DM Mono",monospace;font-size:11px;color:var(--tx2);display:flex;gap:12px;}
.live-c{color:var(--ok);}.live-w{color:var(--bad);}
.next-row{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--tx2);}
.kbd{font-family:"DM Mono",monospace;font-size:9px;background:var(--s2);border:1px solid var(--bdr);border-radius:3px;padding:2px 5px;}
.res-hero{text-align:center;padding:10px 0 28px;}
.ring{width:150px;height:150px;border-radius:50%;margin:0 auto 20px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;}
.ring::before{content:"";position:absolute;inset:10px;border-radius:50%;background:var(--s1);z-index:0;}
.ring-num{font-family:"Playfair Display",serif;font-size:2.2rem;font-weight:900;z-index:1;line-height:1;}
.ring-lbl{font-family:"DM Mono",monospace;font-size:9px;color:var(--tx2);letter-spacing:2px;z-index:1;margin-top:3px;}
.res-title{font-family:"Playfair Display",serif;font-size:1.7rem;margin-bottom:6px;}
.res-sub{color:var(--tx2);font-size:13px;max-width:360px;margin:0 auto;line-height:1.6;}
.res-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-top:22px;}
.res-box{background:var(--s2);border:1px solid var(--bdr);border-radius:9px;padding:15px;text-align:center;}
.res-num{font-family:"Playfair Display",serif;font-size:1.6rem;font-weight:700;}
.res-lbl{font-size:11px;color:var(--tx2);margin-top:3px;}
.dom-list{display:flex;flex-direction:column;gap:7px;}
.dom-row{background:var(--s2);border:1px solid var(--bdr);border-radius:9px;padding:11px 15px;display:flex;align-items:center;gap:11px;}
.dom-icon{font-size:15px;}.dom-info{flex:1;min-width:0;}
.dom-name{font-size:12px;font-weight:600;color:var(--tx);margin-bottom:4px;}
.dom-bar{height:4px;background:rgba(113,128,150,.14);border-radius:2px;overflow:hidden;}
.dom-fill{height:100%;border-radius:2px;transition:width .6s;}
.dom-stat{font-family:"DM Mono",monospace;font-size:10px;color:var(--tx2);margin-top:3px;}
.dom-pct{font-family:"DM Mono",monospace;font-size:12px;min-width:34px;text-align:right;}
.rev-list{display:flex;flex-direction:column;gap:6px;}
.rev-item{border:1px solid var(--bdr);border-radius:10px;background:var(--s1);overflow:hidden;transition:border-color .14s;}
.rev-item.ok{border-color:rgba(104,211,145,.18);}.rev-item.bad{border-color:rgba(252,129,129,.18);}
.rev-item:hover{border-color:var(--acc);}
.rev-hdr{padding:13px 17px;display:flex;align-items:flex-start;gap:9px;cursor:pointer;}
.rev-icon{font-size:12px;flex-shrink:0;margin-top:2px;}
.rev-q{font-size:13px;font-weight:500;color:var(--tx);flex:1;line-height:1.5;}
.rev-chev{color:var(--tx2);font-size:11px;flex-shrink:0;margin-top:3px;transition:transform .2s;}
.rev-item.open .rev-chev{transform:rotate(180deg);}
.rev-body{padding:0;max-height:0;overflow:hidden;transition:max-height .3s ease,padding .3s;}
.rev-item.open .rev-body{max-height:500px;padding:0 17px 15px;}
.rev-ans{font-size:12px;margin:3px 0;}.rev-ans.c{color:var(--ok);}.rev-ans.w{color:var(--bad);}
.rev-exp{margin-top:9px;font-size:12px;color:var(--tx2);line-height:1.7;padding-top:9px;border-top:1px solid var(--bdr);}
.rev-src{margin-top:5px;font-family:"DM Mono",monospace;font-size:10px;color:rgba(212,168,83,.5);}
.act-row{display:flex;gap:9px;flex-wrap:wrap;margin-top:18px;}.act-row .btn-go{flex:1;margin-top:0;}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:9px;}
.stat-box{background:var(--s2);border:1px solid var(--bdr);border-radius:9px;padding:15px;text-align:center;}
.stat-val{font-family:"Playfair Display",serif;font-size:1.6rem;font-weight:700;line-height:1;}
.stat-lbl{font-size:11px;color:var(--tx2);margin-top:4px;}
.ses-list{display:flex;flex-direction:column;gap:5px;}
.ses-item{background:var(--s2);border:1px solid var(--bdr);border-radius:8px;padding:9px 13px;display:flex;align-items:center;gap:11px;}
.ses-pct{font-family:"DM Mono",monospace;font-size:12px;font-weight:600;min-width:38px;}
.ses-pct.p{color:var(--ok);}.ses-pct.f{color:var(--bad);}
.ses-det{color:var(--tx2);flex:1;font-size:11px;}
.ses-date{font-family:"DM Mono",monospace;font-size:10px;color:var(--mut);}
.loading{display:flex;flex-direction:column;align-items:center;gap:14px;padding:52px 20px;text-align:center;}
.spinner{width:32px;height:32px;border:2px solid var(--s2);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;}
.load-txt{font-family:"DM Mono",monospace;font-size:11px;color:var(--tx2);letter-spacing:1px;max-width:280px;line-height:1.6;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(14px);background:var(--s1);border:1px solid var(--bdr);border-radius:8px;padding:10px 18px;font-size:13px;color:var(--tx);opacity:0;transition:.25s;z-index:9999;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.nodata{color:var(--tx2);font-size:13px;text-align:center;padding:24px;opacity:.6;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes fadeup{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:none;}}
@media(max-width:600px){.res-grid{grid-template-columns:repeat(2,1fr);}.dgrid{grid-template-columns:repeat(2,1fr);}.provider-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">
<div class="hdr">
  <div class="badge">&#128065; American Board of Opticianry</div>
  <h1>ABO Mock Exam</h1>
  <p class="sub">Practice across all official ABO/NCLE content domains</p>
</div>

<!-- SETUP -->
<div id="pg-setup" class="page show">
  <div class="tabs">
    <button class="tab on" id="t-setup">&#128203; New Exam</button>
    <button class="tab" id="t-prog">&#128200; Progress</button>
    <button class="tab" id="t-appear">&#127914; Appearance</button>
  </div>

  <div class="card">
    <div class="ctitle">&#127918; Question Source</div>
    <div class="mode-row">
      <div class="mode-text">
        <div class="mode-label" id="mode-label">Offline Bank</div>
        <div class="mode-sub" id="mode-sub">90+ verified questions — works without internet</div>
      </div>
      <div class="tog-wrap">
        <span class="tog-lbl active" id="lbl-off">Offline</span>
        <label class="tog"><input type="checkbox" id="mode-chk"><span class="tog-track"></span></label>
        <span class="tog-lbl" id="lbl-ai">AI</span>
      </div>
    </div>

    <div class="ai-panel" id="ai-panel">
      <div class="ctitle" style="margin-top:14px">&#127916; AI Provider</div>
      <div class="provider-grid">
        <div class="prov-card on" id="prov-groq">
          <div class="prov-name">Groq</div>
          <div class="prov-tag">&#9889; Lightning Fast</div>
          <div class="prov-desc">Dedicated LPU hardware delivers responses in &lt;2 sec. Best for rapid-fire practice. Generous free tier — no credit card required.</div>
        </div>
        <div class="prov-card" id="prov-or">
          <div class="prov-name">OpenRouter</div>
          <div class="prov-tag">&#127919; Most Model Choice</div>
          <div class="prov-desc">One API key, 200+ models — GPT-4, Claude, Llama, DeepSeek and more. Mix free and paid. Best for accessing the smartest models.</div>
        </div>
      </div>

      <div class="model-section show" id="ms-groq">
        <div class="models-ctitle">Select Groq Model</div>
        <div class="model-list" id="ml-groq">
          <div class="mc on" data-mid="llama-3.3-70b-versatile">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Llama 3.3 70B Versatile</div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-fast">Fast</span><span class="mbadge mb-smart">Best Overall</span></div>
              <div class="mc-why">Meta's latest flagship on Groq LPU. Excellent clinical reasoning, accurate ABO calculations, reliable JSON. <strong>Best starting choice.</strong></div>
            </div>
          </div>
          <div class="mc" data-mid="llama3-70b-8192">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Llama 3 70B</div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-fast">Fast</span><span class="mbadge mb-reason">Backup</span></div>
              <div class="mc-why">Original Llama 3 70B — very stable and consistent. Use when 3.3 is rate-limited. Proven for structured output and optics content.</div>
            </div>
          </div>
          <div class="mc" data-mid="mixtral-8x7b-32768">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Mixtral 8x7B</div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-fast">Fast</span></div>
              <div class="mc-why">Mistral AI mixture-of-experts model. Strong at following strict JSON schemas. Good alternative when Llama models are saturated.</div>
            </div>
          </div>
          <div class="mc" data-mid="gemma2-9b-it">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Gemma 2 9B</div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-fast">Ultra-Fast</span></div>
              <div class="mc-why">Google's compact 9B model — absolute fastest generation. Choose for instant questions at the cost of some depth on expert-level content.</div>
            </div>
          </div>
        </div>
        <div class="api-hint">Get a free Groq key (no card) at <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></div>
        <div class="api-row" style="margin-top:8px">
          <input class="api-input" type="password" id="key-groq" placeholder="Groq API key…" autocomplete="off">
          <button class="api-save" id="save-groq">Save</button>
        </div>
        <div class="api-status" id="status-groq"></div>
      </div>

      <div class="model-section" id="ms-or">
        <div class="models-ctitle">Select OpenRouter Model</div>
        <div class="model-list" id="ml-or">
          <div class="mc on" data-mid="meta-llama/llama-3.3-70b-instruct:free">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Llama 3.3 70B Instruct <span style="color:var(--ok);font-size:10px">(Free)</span></div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-smart">Best Free</span></div>
              <div class="mc-why">Same Llama 3.3 70B via OpenRouter's routing. Best free option — use when Groq is rate-limited. Excellent ABO domain accuracy.</div>
            </div>
          </div>
          <div class="mc" data-mid="deepseek/deepseek-r1:free">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">DeepSeek R1 <span style="color:var(--ok);font-size:10px">(Free)</span></div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-reason">Best for Calc</span></div>
              <div class="mc-why">Chain-of-thought reasoning model — works step-by-step before answering. Excellent for Prentice's Rule, vergence, and transposition math. Slower but very accurate on calculations.</div>
            </div>
          </div>
          <div class="mc" data-mid="google/gemma-3-27b-it:free">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Gemma 3 27B <span style="color:var(--ok);font-size:10px">(Free)</span></div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-fast">Reliable</span></div>
              <div class="mc-why">Google's latest free model. Strong instruction following and clean JSON output. Good at anatomy and pathology content.</div>
            </div>
          </div>
          <div class="mc" data-mid="mistralai/mistral-7b-instruct:free">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Mistral 7B Instruct <span style="color:var(--ok);font-size:10px">(Free)</span></div>
              <div class="mc-badges"><span class="mbadge mb-free">Free</span><span class="mbadge mb-fast">Fastest Free</span></div>
              <div class="mc-why">Lean 7B — fastest free option on OpenRouter. Capable for foundation/intermediate questions. Limited on expert-level nuance.</div>
            </div>
          </div>
          <div class="mc" data-mid="anthropic/claude-3.5-sonnet">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">Claude 3.5 Sonnet <span style="color:var(--wrn);font-size:10px">(Paid)</span></div>
              <div class="mc-badges"><span class="mbadge mb-smart">Most Accurate</span><span class="mbadge mb-paid">~$0.003/q</span></div>
              <div class="mc-why">Highest ABO content accuracy and nuanced explanations of any model tested. Best for expert/advanced difficulty. Requires OpenRouter credits.</div>
            </div>
          </div>
          <div class="mc" data-mid="openai/gpt-4o-mini">
            <div class="mc-dot"></div>
            <div class="mc-info">
              <div class="mc-name">GPT-4o Mini <span style="color:var(--wrn);font-size:10px">(Paid)</span></div>
              <div class="mc-badges"><span class="mbadge mb-smart">Reliable</span><span class="mbadge mb-paid">~$0.0002/q</span></div>
              <div class="mc-why">OpenAI's budget flagship — GPT-4 class reasoning at very low cost. Consistent JSON output, strong at math-heavy and regulation questions.</div>
            </div>
          </div>
        </div>
        <div class="api-hint">Get an OpenRouter key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> — many models are free with no credits needed.</div>
        <div class="api-row" style="margin-top:8px">
          <input class="api-input" type="password" id="key-or" placeholder="OpenRouter API key…" autocomplete="off">
          <button class="api-save" id="save-or">Save</button>
        </div>
        <div class="api-status" id="status-or"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">&#128218; Content Domain</div>
    <div class="dgrid" id="domain-grid">
      <button class="dbtn on" data-d="all"><span class="di">&#128301;</span><div class="dn">All Domains</div><div class="ds">Full ABO blueprint</div></button>
      <button class="dbtn" data-d="geometric_optics"><span class="di">&#128302;</span><div class="dn">Geometric Optics</div><div class="ds">Light, vergence, refraction</div></button>
      <button class="dbtn" data-d="ophthalmic_optics"><span class="di">&#128301;</span><div class="dn">Ophthalmic Optics</div><div class="ds">Lens power, prism, Abbe</div></button>
      <button class="dbtn" data-d="lens_materials"><span class="di">&#128142;</span><div class="dn">Lens Materials</div><div class="ds">CR-39, poly, high-index</div></button>
      <button class="dbtn" data-d="lens_designs"><span class="di">&#128083;</span><div class="dn">Lens Designs</div><div class="ds">Bifocal, trifocal, PAL</div></button>
      <button class="dbtn" data-d="coatings"><span class="di">&#10024;</span><div class="dn">Coatings</div><div class="ds">AR, UV, photochromic</div></button>
      <button class="dbtn" data-d="frame_selection"><span class="di">&#128246;</span><div class="dn">Frames</div><div class="ds">Materials, fit, face shapes</div></button>
      <button class="dbtn" data-d="measurements"><span class="di">&#128208;</span><div class="dn">Measurements</div><div class="ds">PD, seg height, vertex</div></button>
      <button class="dbtn" data-d="dispensing"><span class="di">&#128295;</span><div class="dn">Dispensing</div><div class="ds">Fitting, adjusting</div></button>
      <button class="dbtn" data-d="prescriptions"><span class="di">&#128203;</span><div class="dn">Prescriptions</div><div class="ds">Rx, transposition, tolerances</div></button>
      <button class="dbtn" data-d="anatomy"><span class="di">&#129514;</span><div class="dn">Ocular Anatomy</div><div class="ds">Eye structures</div></button>
      <button class="dbtn" data-d="pathology"><span class="di">&#127973;</span><div class="dn">Pathology</div><div class="ds">Cataracts, glaucoma, AMD</div></button>
      <button class="dbtn" data-d="contact_lenses"><span class="di">&#128065;</span><div class="dn">Contact Lenses</div><div class="ds">Types, Dk/t, fitting</div></button>
      <button class="dbtn" data-d="regulations"><span class="di">&#9878;</span><div class="dn">Regulations</div><div class="ds">ANSI, Z87.1, FDA</div></button>
      <button class="dbtn" data-d="safety_eyewear"><span class="di">&#129366;</span><div class="dn">Safety Eyewear</div><div class="ds">Industrial, sports, OSHA</div></button>
      <button class="dbtn" data-d="low_vision"><span class="di">&#128270;</span><div class="dn">Low Vision</div><div class="ds">Magnifiers, aids</div></button>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">&#9889; Difficulty</div>
    <div class="dfgrid" id="diff-grid">
      <button class="dfbtn on" data-df="mixed"><div class="dfbadge" style="background:rgba(99,179,237,.1);color:#63b3ed">Mixed</div><div class="dfname">Balanced</div><div class="dfdesc">Real ABO distribution</div></button>
      <button class="dfbtn" data-df="foundation"><div class="dfbadge" style="background:rgba(104,211,145,.1);color:#68d391">Foundation</div><div class="dfname">Foundational</div><div class="dfdesc">Definitions, basic recall</div></button>
      <button class="dfbtn" data-df="intermediate"><div class="dfbadge" style="background:rgba(246,173,85,.1);color:#f6ad55">Intermediate</div><div class="dfname">Intermediate</div><div class="dfdesc">Applied, moderate calc</div></button>
      <button class="dfbtn" data-df="advanced"><div class="dfbadge" style="background:rgba(252,129,129,.1);color:#fc8181">Advanced</div><div class="dfname">Advanced</div><div class="dfdesc">Complex multi-step</div></button>
      <button class="dfbtn" data-df="expert"><div class="dfbadge" style="background:rgba(183,148,244,.1);color:#b794f4">Expert</div><div class="dfname">Expert</div><div class="dfdesc">Edge cases, nuance</div></button>
      <button class="dfbtn" data-df="calculations"><div class="dfbadge" style="background:rgba(118,228,247,.1);color:#76e4f7">Calc</div><div class="dfname">Calculations</div><div class="dfdesc">Prentice, vergence, prism</div></button>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">&#9881; Settings</div>
    <div class="sgrid">
      <div class="sbox">
        <span class="slabel">Questions</span>
        <div class="rng-wrap">
          <input type="range" id="rng-count" min="5" max="50" step="5" value="10">
          <span class="rng-val" id="rv-count">10</span>
        </div>
        <span class="sbox-desc">5 to 50 per session</span>
      </div>
      <div class="sbox">
        <span class="slabel">Timer Per Question</span>
        <div class="rng-wrap">
          <input type="range" id="rng-timer" min="15" max="120" step="15" value="60">
          <span class="rng-val" id="rv-timer">60s</span>
        </div>
        <span class="sbox-desc">When timed mode is enabled</span>
      </div>
      <div class="sbox">
        <span class="slabel">Explanations</span>
        <div class="seg" id="seg-explain">
          <button class="sgbtn on" data-v="immediate">Immediate</button>
          <button class="sgbtn" data-v="end">At End</button>
          <button class="sgbtn" data-v="never">Off</button>
        </div>
        <span class="sbox-desc">When to show answer rationale</span>
      </div>
      <div class="sbox">
        <span class="slabel">Mode</span>
        <div class="seg" id="seg-exammode">
          <button class="sgbtn on" data-v="practice">Practice</button>
          <button class="sgbtn" data-v="exam">Exam</button>
        </div>
        <span class="sbox-desc" id="exammode-desc">Live score shown</span>
      </div>
      <div class="sbox">
        <span class="slabel">Timed Mode</span>
        <div class="tog-row">
          <span class="tog-state" id="timer-state">Off</span>
          <label class="tog"><input type="checkbox" id="chk-timer"><span class="tog-track"></span></label>
        </div>
        <span class="sbox-desc">Countdown per question</span>
      </div>
      <div class="sbox">
        <span class="slabel">Shuffle Answers</span>
        <div class="tog-row">
          <span class="tog-state on" id="shuffle-state">On</span>
          <label class="tog"><input type="checkbox" id="chk-shuffle" checked><span class="tog-track"></span></label>
        </div>
        <span class="sbox-desc">Randomize option order</span>
      </div>
      <div class="sbox">
        <span class="slabel">Domain Tag</span>
        <div class="tog-row">
          <span class="tog-state on" id="dtag-state">On</span>
          <label class="tog"><input type="checkbox" id="chk-dtag" checked><span class="tog-track"></span></label>
        </div>
        <span class="sbox-desc">Show domain label on question</span>
      </div>
      <div class="sbox">
        <span class="slabel">Difficulty Tag</span>
        <div class="tog-row">
          <span class="tog-state on" id="dftag-state">On</span>
          <label class="tog"><input type="checkbox" id="chk-dftag" checked><span class="tog-track"></span></label>
        </div>
        <span class="sbox-desc">Show difficulty badge on question</span>
      </div>
    </div>
  </div>
  <button class="btn-go" id="btn-start">&#9654;&#160;&#160;Begin Mock Exam</button>
</div>

<!-- PROGRESS -->
<div id="pg-prog" class="page">
  <div class="tabs">
    <button class="tab" id="t-setup2">&#128203; New Exam</button>
    <button class="tab on" id="t-prog2">&#128200; Progress</button>
    <button class="tab" id="t-appear2">&#127914; Appearance</button>
  </div>
  <div class="card"><div class="ctitle">&#128200; Overall Statistics</div><div class="stat-grid" id="stat-grid"></div></div>
  <div class="card"><div class="ctitle">&#127919; Domain Performance</div><div class="dom-list" id="prog-doms"></div></div>
  <div class="card"><div class="ctitle">&#128336; Recent Sessions</div><div class="ses-list" id="ses-list"></div></div>
  <div style="margin-top:12px;text-align:right"><button class="btn-sec btn-danger" id="btn-clear">&#128465; Reset All Progress</button></div>
</div>

<!-- APPEARANCE -->
<div id="pg-appear" class="page">
  <div class="tabs">
    <button class="tab" id="t-setup3">&#128203; New Exam</button>
    <button class="tab" id="t-prog3">&#128200; Progress</button>
    <button class="tab on" id="t-appear3">&#127914; Appearance</button>
  </div>
  <div class="card">
    <div class="ctitle">&#127914; Color Theme</div>
    <p style="font-size:12px;color:var(--tx2);margin-bottom:16px;">Pick a color scheme. Your choice is saved automatically.</p>
    <div class="theme-swatches" id="theme-swatches"></div>
  </div>
  <div class="card">
    <div class="ctitle">&#128065; Theme Preview</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:12px">
      <div class="res-box"><div class="res-num" style="color:var(--acc)">Aa</div><div class="res-lbl">Accent</div></div>
      <div class="res-box"><div class="res-num" style="color:var(--ok)">&#10003;</div><div class="res-lbl">Correct</div></div>
      <div class="res-box"><div class="res-num" style="color:var(--bad)">&#10007;</div><div class="res-lbl">Wrong</div></div>
    </div>
    <div class="opt" style="pointer-events:none;margin-bottom:7px"><span class="opt-l">A</span><span>Sample answer option</span></div>
    <div class="opt ok" style="pointer-events:none;margin-bottom:7px"><span class="opt-l">B</span><span>Correct answer highlight</span></div>
    <div class="opt bad" style="pointer-events:none"><span class="opt-l">C</span><span>Incorrect answer highlight</span></div>
  </div>
</div>

<!-- QUIZ -->
<div id="pg-quiz" class="page">
  <div id="timer-row" class="timer-row" style="display:none">
    <div class="tnum" id="tnum">60</div>
    <div class="tbar"><div class="tbar-fill" id="tbar-fill" style="width:100%"></div></div>
  </div>
  <div class="prog"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  <div id="qcard" class="card"></div>
  <div class="qfoot">
    <div class="live" id="live-wrap">&#10003;&#160;<span class="live-c" id="live-c">0</span>&#160;&#160;&#10007;&#160;<span class="live-w" id="live-w">0</span>&#160;&#160;<span id="live-p" style="color:var(--tx2)">0/0</span></div>
    <div class="next-row" id="next-row" style="display:none">
      <span class="kbd">Space</span>&#160;/&#160;<span class="kbd">&#8594;</span>
      <button class="btn-sec" id="btn-next">Next &#8594;</button>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div id="pg-results" class="page">
  <div class="card">
    <div class="res-hero">
      <div class="ring" id="result-ring"><div class="ring-num" id="ring-num">-</div><div class="ring-lbl">SCORE</div></div>
      <div class="res-title" id="res-title">-</div>
      <div class="res-sub" id="res-sub">-</div>
      <div class="res-grid">
        <div class="res-box"><div class="res-num" style="color:var(--ok)" id="rs-c">0</div><div class="res-lbl">Correct</div></div>
        <div class="res-box"><div class="res-num" style="color:var(--bad)" id="rs-w">0</div><div class="res-lbl">Wrong</div></div>
        <div class="res-box"><div class="res-num" style="color:var(--acc)" id="rs-t">0</div><div class="res-lbl">Total</div></div>
        <div class="res-box"><div class="res-num" style="color:var(--wrn)" id="rs-time">-</div><div class="res-lbl">Avg Time</div></div>
      </div>
    </div>
  </div>
  <div class="card"><div class="ctitle">&#128202; Domain Breakdown</div><div class="dom-list" id="res-doms"></div></div>
  <div class="card"><div class="ctitle">&#128214; Review All Questions</div><div class="rev-list" id="rev-list"></div></div>
  <div class="act-row">
    <button class="btn-sec" id="btn-new">&#8592; New Exam</button>
    <button class="btn-go" id="btn-retry" style="display:none">&#8635; Retry Incorrect</button>
  </div>
</div>

</div><!-- /wrap -->
<div class="toast" id="toast"></div>
<script id="bank-data" type="application/json">
[
  {"domain":"geometric_optics","difficulty":"foundation","question":"What is vergence?","options":["The bending of light at a lens surface","The reciprocal of object or image distance in meters","The speed of light in a medium","The angle of incidence"],"correct":1,"explanation":"Vergence (L) = n/l. Describes whether rays converge (+) or diverge (-), in diopters. Object vergence is always negative (diverging from source).","source":"ABO Study Guide: Geometric Optics — Vergence"},
  {"domain":"geometric_optics","difficulty":"foundation","question":"Snell's Law states:","options":["Frequency changes at an interface","n1·sinθ1 = n2·sinθ2","Speed is constant in all media","Wavelength is preserved across boundaries"],"correct":1,"explanation":"n1·sinθ1 = n2·sinθ2. Light bends toward the normal entering a denser medium. Frequency never changes; wavelength and speed do.","source":"ABO: Geometric Optics — Refraction / Snell's Law"},
  {"domain":"geometric_optics","difficulty":"intermediate","question":"A lens has a focal length of 0.25 m. Its power is:","options":["+0.25 D","+2.50 D","+4.00 D","+25.00 D"],"correct":2,"explanation":"Power (D) = 1/f(m) = 1/0.25 = +4.00 D. Fundamental diopter definition.","source":"ABO: Geometric Optics — Lens Power"},
  {"domain":"geometric_optics","difficulty":"intermediate","question":"Prentice's Rule: prism 8 mm below the OC of a +5.00 D lens:","options":["2Δ BU","3Δ BU","4Δ BU","5Δ BU"],"correct":2,"explanation":"P = F × d(cm) = 5.00 × 0.8 = 4Δ. Plus lens displaced below OC = Base Up prism.","source":"ABO: Geometric Optics — Prentice's Rule P=Fd"},
  {"domain":"geometric_optics","difficulty":"advanced","question":"Critical angle for glass (n=1.5) to air (n=1.0) is approximately:","options":["42°","48°","62°","72°"],"correct":0,"explanation":"θc = arcsin(n2/n1) = arcsin(1.0/1.5) ≈ 41.8°. Beyond this, total internal reflection occurs — no light exits the denser medium.","source":"ABO: Geometric Optics — Total Internal Reflection"},
  {"domain":"geometric_optics","difficulty":"intermediate","question":"Prism induced 5 mm temporal to the OC of a -3.00 D lens:","options":["0.5Δ BI","1.5Δ BI","2.5Δ BI","3.5Δ BI"],"correct":1,"explanation":"P = 3.00 × 0.5 = 1.5Δ. Minus lens displaced temporally = Base In (base toward optical center).","source":"ABO: Geometric Optics — Prentice's Rule"},
  {"domain":"geometric_optics","difficulty":"foundation","question":"Index of refraction of air is:","options":["0.75","1.00","1.33","1.52"],"correct":1,"explanation":"Air n ≈ 1.000. Water n ≈ 1.333, crown glass n ≈ 1.523, CR-39 n ≈ 1.498.","source":"ABO: Geometric Optics — Refractive Index"},
  {"domain":"ophthalmic_optics","difficulty":"foundation","question":"A lens clock (Geneva lens measure) directly reads:","options":["Lens thickness","Surface power based on sag measurement","Induced prism","Optical center location"],"correct":1,"explanation":"Lens clock reads surface power in diopters, calibrated for crown glass (n=1.523). Apply index correction factor for other materials.","source":"ABO: Ophthalmic Optics — Lens Clock"},
  {"domain":"ophthalmic_optics","difficulty":"advanced","question":"Chromatic aberration is minimized by selecting materials with:","options":["Higher refractive index","Higher Abbe value (V-number)","Lower Abbe value","Greater center thickness"],"correct":1,"explanation":"Abbe value V = (n_d−1)/(n_F−n_C). Higher V = less dispersion = less chromatic aberration. CR-39 V≈58, Trivex V≈43, Polycarbonate V≈30.","source":"ABO: Ophthalmic Optics — Abbe Value"},
  {"domain":"ophthalmic_optics","difficulty":"foundation","question":"Nominal power: front +8.00 D, back -5.00 D:","options":["-3.00 D","+3.00 D","+5.00 D","+13.00 D"],"correct":1,"explanation":"Nominal (thin lens) power = F1 + F2 = +8.00 + (-5.00) = +3.00 D.","source":"ABO: Ophthalmic Optics — Nominal Power"},
  {"domain":"ophthalmic_optics","difficulty":"intermediate","question":"Moving a minus lens closer to the eye:","options":["Increases effective minus power","Decreases effective minus power","Has no effect on power","Only matters for plus lenses"],"correct":0,"explanation":"Minus lens closer = more minus effective power. Clinically significant when Rx > ±4.00 D. Vertex distance must be recorded and matched.","source":"ABO: Ophthalmic Optics — Vertex Distance Effect"},
  {"domain":"ophthalmic_optics","difficulty":"advanced","question":"The lensometer measures:","options":["Front surface power","Back vertex power of a finished lens","Center thickness","Abbe value"],"correct":1,"explanation":"Lensometer reads back vertex power — the clinically relevant power that matches the refraction. Neutralizes vergence from the back surface.","source":"ABO: Ophthalmic Optics — Lensometer"},
  {"domain":"lens_materials","difficulty":"foundation","question":"Index of refraction of CR-39 plastic:","options":["1.498","1.523","1.586","1.600"],"correct":0,"explanation":"CR-39: n ≈ 1.498, Abbe value ≈ 58, specific gravity ≈ 1.32. Most commonly prescribed ophthalmic lens material worldwide.","source":"ABO: Lens Materials — CR-39"},
  {"domain":"lens_materials","difficulty":"foundation","question":"Highest impact resistance, required for children's eyewear by ANSI:","options":["Crown glass","CR-39","Polycarbonate","High-index 1.74"],"correct":2,"explanation":"Polycarbonate: inherent impact resistance far exceeds glass or CR-39. Inherently blocks UV. Required by ANSI for safety and recommended for pediatric Rx.","source":"ABO: Lens Materials — Polycarbonate; ANSI Z87.1"},
  {"domain":"lens_materials","difficulty":"intermediate","question":"Abbe value of polycarbonate is approximately:","options":["28-30","43-45","58","67"],"correct":0,"explanation":"Polycarbonate Abbe ≈ 28-30 — lowest of common ophthalmic materials. Causes noticeable chromatic aberration (color fringing) at gaze angles away from OC.","source":"ABO: Lens Materials — Polycarbonate Abbe Value"},
  {"domain":"lens_materials","difficulty":"intermediate","question":"Trivex lens material Abbe value is approximately:","options":["28-30","43-45","58","67"],"correct":1,"explanation":"Trivex: n ≈ 1.53, Abbe ≈ 43-45, specific gravity ≈ 1.11 (lightest of all common materials). Impact resistance comparable to polycarbonate with better optical clarity.","source":"ABO: Lens Materials — Trivex Properties"},
  {"domain":"lens_materials","difficulty":"intermediate","question":"For -8.00 DS, thinnest lens material:","options":["CR-39 n=1.50","Crown glass n=1.523","Polycarbonate n=1.586","High-index 1.67"],"correct":3,"explanation":"Higher index = thinner edge for minus lenses. Ranking thinnest to thickest: 1.67 > 1.586 (PC) > 1.523 (glass) > 1.498 (CR-39).","source":"ABO: Lens Materials — High-Index / Edge Thickness"},
  {"domain":"lens_materials","difficulty":"foundation","question":"Inherently blocks 100% UV with no added coating:","options":["CR-39","Crown glass","Trivex","Polycarbonate"],"correct":3,"explanation":"Polycarbonate absorbs UV up to ~380-400nm inherently. CR-39 and glass transmit UV — require UV coating. Trivex also provides good inherent UV protection.","source":"ABO: Lens Materials — UV Properties"},
  {"domain":"lens_designs","difficulty":"foundation","question":"Most commonly prescribed flat-top bifocal segment width:","options":["22 mm","25 mm","28 mm","35 mm"],"correct":2,"explanation":"FT-28 (flat-top 28mm) is the standard bifocal. FT-35 is wider for occupational use. Flat top provides consistent segment height unlike round segs.","source":"ABO: Lens Designs — Bifocal Segments"},
  {"domain":"lens_designs","difficulty":"foundation","question":"In a PAL, the near reading zone is located:","options":["At the top","In the center","At the bottom","Identical to the distance zone"],"correct":2,"explanation":"PAL layout: distance zone (top) → progressive corridor (increasing power) → near zone (bottom). Fitting cross marks the distance reference point at pupil center.","source":"ABO: Lens Designs — Progressive Addition Lenses"},
  {"domain":"lens_designs","difficulty":"intermediate","question":"Executive (Franklin) bifocal differs from flat-top because:","options":["Smaller segment","Segment line spans full lens width","No visible line","Reading only lens"],"correct":1,"explanation":"Executive/Franklin: dividing line runs full horizontal lens width, providing maximum near field. No seg edges limiting peripheral near vision.","source":"ABO: Lens Designs — Executive Bifocal"},
  {"domain":"lens_designs","difficulty":"intermediate","question":"Trifocal adds over a bifocal:","options":["No visible lines","An intermediate zone at arm's length","Less thickness","Lower cost"],"correct":1,"explanation":"Trifocal adds intermediate segment (typically half the near add — e.g., +1.25 if add is +2.50) above the near segment. Useful for computer distance (~50 cm).","source":"ABO: Lens Designs — Trifocals"},
  {"domain":"lens_designs","difficulty":"advanced","question":"In PALs, unwanted astigmatic error is concentrated in the:","options":["Distance zone","Reading zone","Progressive corridor","Lateral peripheral zones"],"correct":3,"explanation":"PAL trade-off: lateral nasal/temporal areas contain unavoidable astigmatic error causing 'swim' and blur. Wider corridor = more peripheral aberration. Cannot be eliminated by design.","source":"ABO: Lens Designs — PAL Optical Performance"},
  {"domain":"coatings","difficulty":"foundation","question":"AR coatings eliminate reflections by:","options":["Absorbing reflected light","Thin-film destructive interference","Thickening the lens surface","Increasing refractive index"],"correct":1,"explanation":"AR coatings use thin-film interference: quarter-wavelength layers create 180° phase shift causing destructive interference. Reduces surface reflections from ~8% to ~0.5%.","source":"ABO: Coatings — Anti-Reflective Physics"},
  {"domain":"coatings","difficulty":"foundation","question":"UV400 protection blocks UV up to:","options":["320 nm","350 nm","380 nm","400 nm"],"correct":3,"explanation":"UV400 blocks all UV up to 400nm: UVB (280-315nm) + UVA (315-400nm). FDA considers a lens UV-blocking if it blocks >99% of UV-A and UV-B.","source":"ABO: Coatings — UV Standards"},
  {"domain":"coatings","difficulty":"intermediate","question":"Photochromic lenses fail to darken while driving because:","options":["Heat deactivates them in summer","Windshields block the UV needed to trigger darkening","They only activate in polarized light","Car glass blocks all visible light"],"correct":1,"explanation":"Modern laminated windshields block most UV (320-380nm). Photochromic molecules require UV to trigger the darkening reaction. No UV = no darkening inside most vehicles.","source":"ABO: Coatings — Photochromic Limitations"},
  {"domain":"coatings","difficulty":"foundation","question":"Polarized lenses primarily reduce:","options":["UV radiation","Horizontally polarized glare from flat surfaces","Chromatic aberration","Peripheral distortion"],"correct":1,"explanation":"Polarized lenses contain a vertical-axis filter that blocks horizontally polarized light — the type of glare from roads, water, and snow. Does not replace UV protection.","source":"ABO: Coatings — Polarized Lenses"},
  {"domain":"frame_selection","difficulty":"foundation","question":"In the boxing system, the 'A' measurement is:","options":["Bridge width","Horizontal lens width","Vertical lens depth","Temple length"],"correct":1,"explanation":"Boxing system (ANSI/ISO): A = horizontal box width, B = vertical box depth, DBL = distance between lens boxes. Frame size: A □ DBL (e.g., 52 □ 18).","source":"ABO: Frame Selection — Boxing System"},
  {"domain":"frame_selection","difficulty":"foundation","question":"DBL stands for:","options":["Distance Between Lenses","Depth of Bridge Length","Diagonal Bridge Line","Datum Base Line"],"correct":0,"explanation":"DBL = Distance Between Lenses. Measured between the inner edges of the two lens boxes. Not the bridge width itself.","source":"ABO: Frame Selection — Boxing System DBL"},
  {"domain":"frame_selection","difficulty":"intermediate","question":"For a round face, the recommended frame shape is:","options":["Round","Oval","Rectangular or angular","Small rimless round"],"correct":2,"explanation":"Frame shape should contrast face shape. Round face → angular/rectangular adds definition. The principle: contrast the predominant face shape.","source":"ABO: Frame Selection — Face Shapes"},
  {"domain":"frame_selection","difficulty":"intermediate","question":"Titanium frames preferred for nickel allergy patients because:","options":["They are lighter","They are hypoallergenic and nickel-free","They are stronger","They adjust more easily"],"correct":1,"explanation":"Titanium is biocompatible and nickel-free. Nickel is the most common metal contact allergen (Type IV hypersensitivity). Beta-titanium and pure titanium are safe alternatives.","source":"ABO: Frame Selection — Materials & Allergies"},
  {"domain":"frame_selection","difficulty":"intermediate","question":"Minimum blank size formula:","options":["A + B + DBL","ED + 2 mm","A + DBL + (2 × largest decentration)","A + B/2 + DBL"],"correct":2,"explanation":"Minimum blank size = A + DBL + (2 × largest decentration). Decentration = |PD − frame PD/2|. Ensures blank covers full lens opening after edging.","source":"ABO: Frame Selection — Blank Size Calculation"},
  {"domain":"measurements","difficulty":"foundation","question":"When measuring distance PD, the patient fixates on:","options":["Examiner's right eye","Examiner's left eye","A target at 20 ft","The floor"],"correct":1,"explanation":"Patient fixates on examiner's left eye → patient's right eye looks straight ahead → right monocular PD measured. Reverse for left PD. Ensures straight-ahead (distance) gaze.","source":"ABO: Measurements — PD Measurement Technique"},
  {"domain":"measurements","difficulty":"foundation","question":"Near PD is typically less than distance PD by:","options":["1-2 mm total","3-4 mm total","5-6 mm total","7-8 mm total"],"correct":1,"explanation":"Near PD ≈ distance PD minus 3-4mm (~1.5-2mm per eye convergence at 40cm working distance). More precise: measure monocular near PD directly.","source":"ABO: Measurements — Near vs Distance PD"},
  {"domain":"measurements","difficulty":"intermediate","question":"Seg height for a flat-top bifocal is measured from:","options":["Top of segment to frame bottom","Lower limbus or pupil center to lowest frame point","Distance OC to segment top","Lower segment edge to frame top"],"correct":1,"explanation":"Seg height = vertical distance from the lower limbus (or pupil center) to the lowest point of the frame. Segment top aligns at this height.","source":"ABO: Measurements — Segment Height"},
  {"domain":"measurements","difficulty":"foundation","question":"Pantoscopic tilt means the frame has:","options":["The top rim tilting left or right","Bottom rim closer to the face than the top","Top rim closer to face than bottom","Bridge rotating laterally"],"correct":1,"explanation":"Pantoscopic tilt: bottom rim closer to cheek, top farther from face. Normal: 8-12°. Each 2° tilt effectively drops the OC by 1mm.","source":"ABO: Measurements — Pantoscopic Tilt"},
  {"domain":"dispensing","difficulty":"foundation","question":"First step when dispensing completed eyewear:","options":["Adjust the frame","Verify Rx matches the work order (lensometer + ANSI check)","Clean the lenses","Explain warranty"],"correct":1,"explanation":"Always verify power, axis, add, prism, PD, seg height, and optical quality before fitting. Catching a lab error before the patient sits down is essential.","source":"ABO: Dispensing — Verification Protocol"},
  {"domain":"dispensing","difficulty":"intermediate","question":"Frame slides down the nose — correct nose pad adjustment:","options":["Add more pantoscopic tilt","Move nose pads inward (closer together)","Move nose pads outward","Extend the temples"],"correct":1,"explanation":"Moving pads inward increases nose contact pressure, preventing downward sliding. First adjustment for metal frames with adjustable nose pads.","source":"ABO: Dispensing — Nose Pad Adjustment"},
  {"domain":"dispensing","difficulty":"intermediate","question":"Each 2° of pantoscopic tilt effectively moves the OC:","options":["0.5mm upward","1mm downward","1mm upward","2mm downward"],"correct":1,"explanation":"Rule: each 2° pantoscopic tilt = OC drops 1mm. For PALs: set the fitting cross 1mm higher per 2° of tilt to maintain proper distance zone and reading access.","source":"ABO: Dispensing — Pantoscopic Tilt & OC Position"},
  {"domain":"dispensing","difficulty":"foundation","question":"Standard vertex distance for ophthalmic dispensing:","options":["5-8 mm","12-14 mm","18-22 mm","25-30 mm"],"correct":1,"explanation":"Standard vertex distance: 12-14mm (lens back to corneal apex). For Rx > ±4.00D, vertex distance used during refraction must be matched during dispensing.","source":"ABO: Dispensing — Vertex Distance"},
  {"domain":"dispensing","difficulty":"intermediate","question":"New PAL patient reports 'swimming' and nausea. Most likely cause:","options":["Wrong monocular PD","Incorrect segment height","Wrong add power","Wrong cylinder axis"],"correct":1,"explanation":"Incorrect seg height is the most common PAL adaptation problem. Too high: patient can't access distance without tilting head. Too low: can't access near zone without exaggerated chin tuck.","source":"ABO: Dispensing — PAL Troubleshooting"},
  {"domain":"prescriptions","difficulty":"foundation","question":"Transpose +2.00 +1.50 x 090 to minus cylinder form:","options":["+3.50 -1.50 x 180","+3.50 -1.50 x 090","+2.00 -1.50 x 090","+0.50 +1.50 x 090"],"correct":0,"explanation":"New sphere = +2.00 + (+1.50) = +3.50. New cylinder = -1.50. New axis = 090 + 90 = 180. Result: +3.50 -1.50 x 180.","source":"ABO: Prescriptions — Rx Transposition"},
  {"domain":"prescriptions","difficulty":"foundation","question":"Spherical equivalent of +2.00 -1.00 x 045:","options":["+1.00 DS","+1.50 DS","+2.00 DS","+2.50 DS"],"correct":1,"explanation":"SE = sphere + (cylinder/2) = +2.00 + (-1.00/2) = +2.00 - 0.50 = +1.50 DS. Used for contact lens power approximation.","source":"ABO: Prescriptions — Spherical Equivalent"},
  {"domain":"prescriptions","difficulty":"intermediate","question":"ANSI Z80.1 power tolerance for Rx up to ±6.50 D:","options":["±0.06 D","±0.12 D","±0.13 D","±0.25 D"],"correct":1,"explanation":"ANSI Z80.1-2022: sphere and cylinder power tolerance = ±0.12 D for powers ≤ ±6.50 D. For powers > ±6.50 D, tolerance = ±2% of the power.","source":"ANSI Z80.1-2022 — Prescription Lens Tolerances"},
  {"domain":"prescriptions","difficulty":"intermediate","question":"Transpose -1.00 -2.00 x 045 to plus cylinder form:","options":["-3.00 +2.00 x 135","-3.00 +2.00 x 045","-1.00 +2.00 x 135","-2.00 +1.00 x 045"],"correct":0,"explanation":"New sphere = -1.00 + (-2.00) = -3.00. New cylinder = +2.00. New axis = 045 + 90 = 135. Result: -3.00 +2.00 x 135.","source":"ABO: Prescriptions — Plus Cylinder Transposition"},
  {"domain":"prescriptions","difficulty":"advanced","question":"For -2.00 -1.00 x 180, power at the 90° meridian:","options":["-1.00 D","-2.00 D","-3.00 D","-4.00 D"],"correct":2,"explanation":"Minus cylinder: sphere acts at axis meridian (180°). Power at 90° = sphere + cylinder = -2.00 + (-1.00) = -3.00 D. Power at 180° = -2.00 D.","source":"ABO: Prescriptions — Meridional Power / Power Cross"},
  {"domain":"prescriptions","difficulty":"intermediate","question":"Spherical equivalent of -3.00 -2.00 x 090:","options":["-1.00 DS","-2.00 DS","-3.00 DS","-4.00 DS"],"correct":3,"explanation":"SE = -3.00 + (-2.00/2) = -3.00 + (-1.00) = -4.00 DS. Represents average power across all meridians.","source":"ABO: Prescriptions — Spherical Equivalent"},
  {"domain":"anatomy","difficulty":"foundation","question":"Transparent, avascular anterior structure providing ~65-75% of total refractive power:","options":["Sclera","Cornea","Conjunctiva","Anterior lens"],"correct":1,"explanation":"Cornea provides ~43-44 D of the total ~60 D ocular power (~72%). Avascular (nourished by tears and aqueous). Injury/edema causes opacity.","source":"ABO: Ocular Anatomy — Cornea"},
  {"domain":"anatomy","difficulty":"foundation","question":"Innermost cellular layer of the cornea:","options":["Epithelium","Bowman's layer","Stroma","Endothelium"],"correct":3,"explanation":"Layers front to back: Epithelium → Bowman's layer → Stroma (90% of thickness) → Descemet's membrane → Endothelium. Endothelium pumps water out, keeping cornea dehydrated and clear.","source":"ABO: Ocular Anatomy — Corneal Layers"},
  {"domain":"anatomy","difficulty":"intermediate","question":"The fovea centralis:","options":["Located at the optic disc","Center of macula, cones only, highest acuity","On nasal retina temporal to the disc","Far peripheral retina"],"correct":1,"explanation":"Fovea: 1.5mm central depression of the macula. Only cones (~6 million). Highest visual acuity (20/20+). Avascular — nourished by underlying choroid.","source":"ABO: Ocular Anatomy — Fovea & Macula"},
  {"domain":"anatomy","difficulty":"intermediate","question":"Aqueous humor is produced by the:","options":["Corneal endothelium","Ciliary body","Iris dilator muscle","Trabecular meshwork"],"correct":1,"explanation":"Ciliary body produces aqueous via ultrafiltration + active secretion. Flow: posterior chamber → pupil → anterior chamber → trabecular meshwork → Schlemm's canal → venous system.","source":"ABO: Ocular Anatomy — Aqueous Humor"},
  {"domain":"anatomy","difficulty":"foundation","question":"Crystalline lens suspended by:","options":["Corneal ligaments","Zonules of Zinn","Aqueous pressure alone","Posterior vitreous"],"correct":1,"explanation":"Zonules of Zinn connect lens capsule to ciliary body. Ciliary muscle contraction → zonules relax → lens thickens (accommodation for near). Relaxed ciliary → taut zonules → flat lens (distance).","source":"ABO: Ocular Anatomy — Crystalline Lens & Accommodation"},
  {"domain":"pathology","difficulty":"foundation","question":"Cataract type most associated with diabetes and corticosteroid use:","options":["Nuclear sclerotic","Anterior cortical","Posterior subcapsular (PSC)","Posterior cortical"],"correct":2,"explanation":"PSC: opacity at posterior lens capsule pole. Associated with: diabetes, corticosteroids (systemic/inhaled/topical), radiation, uveitis. Disproportionately affects near vision and causes severe glare.","source":"ABO: Pathology — Cataract Types & Etiology"},
  {"domain":"pathology","difficulty":"foundation","question":"Glaucoma is characterized by:","options":["Crystalline lens clouding","Progressive optic nerve damage, often from elevated IOP","Macular degeneration","Corneal scarring"],"correct":1,"explanation":"Glaucoma: optic neuropathy with characteristic cupping and visual field loss. Normal IOP: 10-21 mmHg. Primary open-angle glaucoma (POAG) is most common. Risk factors: IOP, family history, thin cornea, age.","source":"ABO: Pathology — Glaucoma"},
  {"domain":"pathology","difficulty":"intermediate","question":"AMD primarily causes loss of:","options":["Peripheral vision","Central (straight-ahead) vision","Color vision only","Night vision only"],"correct":1,"explanation":"AMD destroys macular photoreceptors → central scotoma, metamorphopsia. Peripheral vision preserved. Wet AMD: choroidal neovascularization. Leading cause of legal blindness age >65 in developed countries.","source":"ABO: Pathology — Age-Related Macular Degeneration"},
  {"domain":"pathology","difficulty":"intermediate","question":"Keratoconus is:","options":["Retinal detachment","Progressive corneal thinning and forward bulging (ectasia)","Posterior lens capsule opacity","Elevated IOP with no angle closure"],"correct":1,"explanation":"Keratoconus: stromal thinning → cornea bulges into cone shape → irregular astigmatism, high myopia, reduced BCVA. RGP/scleral CL mask irregularity. Collagen cross-linking (CXL) halts progression.","source":"ABO: Pathology — Keratoconus"},
  {"domain":"pathology","difficulty":"foundation","question":"Myopia is corrected with:","options":["Plus (converging) lenses","Minus (diverging) lenses","Prism lenses","Cylindrical lenses only"],"correct":1,"explanation":"Myopia: parallel rays focus anterior to retina. Minus lens diverges rays before entering eye, moving focal point back to retina. Each -1.00 D corrects ~1mm of excess axial length.","source":"ABO: Pathology — Refractive Errors"},
  {"domain":"pathology","difficulty":"foundation","question":"Presbyopia is caused by:","options":["Corneal flattening with age","Loss of crystalline lens elasticity reducing accommodation","Increasing IOP after 40","Retinal thinning in the macula"],"correct":1,"explanation":"Presbyopia: age-related lens sclerosis reduces elasticity and accommodative amplitude. Manifest ~age 40-45. Amplitude decreases ~0.25D/year. Corrected with reading adds, PALs, or monovision.","source":"ABO: Pathology — Presbyopia & Accommodation"},
  {"domain":"contact_lenses","difficulty":"foundation","question":"Dk/t represents:","options":["Lens diameter / thickness","Oxygen transmissibility through the lens","Water content / thickness","Lens power / diameter"],"correct":1,"explanation":"Dk/t = oxygen transmissibility. D = diffusion coefficient, k = O2 solubility, t = lens thickness. Extended wear requires Dk/t ≥ 87; daily wear ≥ 24.","source":"ABO: Contact Lenses — Oxygen Transmissibility"},
  {"domain":"contact_lenses","difficulty":"intermediate","question":"Contact lens base curve refers to:","options":["Refractive power","Overall lens diameter","Radius of curvature of posterior surface (mm)","Water content percentage"],"correct":2,"explanation":"Base curve (BC): posterior surface radius in mm. Steeper fit = smaller BC number. Wrong BC impairs lens movement and corneal oxygen supply.","source":"ABO: Contact Lenses — Lens Parameters"},
  {"domain":"contact_lenses","difficulty":"intermediate","question":"Most appropriate contact lens for keratoconus:","options":["Daily disposable soft spherical","Standard soft toric","RGP or scleral lens","Cosmetic plano tinted"],"correct":2,"explanation":"RGP/scleral lenses vault over the irregular cornea, creating a tear lens that neutralizes irregular astigmatism. Soft lenses conform to the irregular surface and cannot correct it.","source":"ABO: Contact Lenses — Specialty Fitting"},
  {"domain":"contact_lenses","difficulty":"foundation","question":"Silicone hydrogel lenses were developed to:","options":["Improve moisture retention","Dramatically increase oxygen transmissibility","Reduce manufacturing cost","Correct higher prescriptions"],"correct":1,"explanation":"Traditional hydrogel relies on water for O2 delivery. Silicone hydrogel: silicone matrix allows O2 to diffuse directly — Dk 5-10× higher. Enables safer extended wear and reduces hypoxic complications.","source":"ABO: Contact Lenses — Silicone Hydrogel Materials"},
  {"domain":"regulations","difficulty":"foundation","question":"FDA drop-ball impact test requires:","options":["1-inch ball from 10 inches","5/8-inch ball from 50 inches","5/8-inch ball from 10 inches","1-inch ball from 50 inches"],"correct":1,"explanation":"21 CFR 801.410: 5/8-inch (15.9mm) steel ball from 50 inches. Lens must not fracture, chip, or crack. All finished prescription lenses sold in the US must pass or have an exemption.","source":"21 CFR 801.410 — FDA Impact Resistance"},
  {"domain":"regulations","difficulty":"intermediate","question":"ANSI Z80.1 governs tolerances for:","options":["Safety eyewear","Prescription ophthalmic dress lenses","Non-prescription sunglasses","Contact lenses"],"correct":1,"explanation":"ANSI Z80.1 (2022): tolerances for prescription ophthalmic lenses (power, prism, axis, optical quality). Z87.1 = safety eyewear. Z80.3 = non-prescription sunglasses.","source":"ANSI Z80.1-2022 — Prescription Ophthalmic Lenses"},
  {"domain":"regulations","difficulty":"intermediate","question":"Z87+ marking indicates:","options":["Basic impact only","Passed high-velocity AND high-mass impact tests","UV protection included","Polarized lens"],"correct":1,"explanation":"ANSI Z87.1: Z87+ = passes high-velocity (1-inch ball at 150 fps) AND high-mass (17.6 oz pointed projectile) tests. Z87 alone = basic impact only (FDA drop ball). Critical distinction for industrial environments.","source":"ANSI/ISEA Z87.1-2020 — Occupational Eye Protection"},
  {"domain":"regulations","difficulty":"intermediate","question":"ANSI Z80.1 axis tolerance for a -2.25 D cylinder:","options":["±2°","±3°","±5°","±7°"],"correct":1,"explanation":"Z80.1 axis tolerances: ≤0.12D = ±14°; 0.25D = ±7°; 0.50D = ±5°; 0.75-1.50D = ±3°; >1.50D = ±2°. At -2.25D (>1.50D): ±2°.","source":"ANSI Z80.1-2022 — Axis Tolerance Table"},
  {"domain":"safety_eyewear","difficulty":"foundation","question":"Side shields required when:","options":["Prescription exceeds +4.00D","Hazards can approach from the side","Working outdoors only","Frame material is metal"],"correct":1,"explanation":"OSHA 29 CFR 1910.133 and ANSI Z87.1: side shields required when hazard sources are lateral or overhead. Wrap-around designs may substitute.","source":"OSHA 29 CFR 1910.133; ANSI Z87.1"},
  {"domain":"safety_eyewear","difficulty":"intermediate","question":"OSHA 29 CFR 1910.133 mandates eye protection for:","options":["Any chemical use","Flying particles, molten metal, liquid chemicals, injurious radiation","Driving any vehicle","Computer/VDT work"],"correct":1,"explanation":"1910.133(a)(1): required for flying particles, molten metal, liquid chemicals, acids, caustic liquids, chemical gases/vapors, and injurious radiation. Applies to all employees in those environments.","source":"OSHA 29 CFR 1910.133(a)"},
  {"domain":"safety_eyewear","difficulty":"intermediate","question":"Racquet sports require eye protection rated under:","options":["ANSI Z87.1","ASTM F803","ISO 18369","OSHA 1910.133"],"correct":1,"explanation":"ASTM F803: Standard for eye protection in racquet sports. Z87.1 safety glasses are NOT sufficient — the ball can enter standard frame openings and frames may shatter under ball impact.","source":"ASTM F803 — Eye Protectors for Racket Sports"},
  {"domain":"low_vision","difficulty":"foundation","question":"Low vision is BCVA:","options":["20/20 or better","Worse than 20/40, not improvable with standard Rx","20/200 or worse in better eye","Worse than 20/400"],"correct":1,"explanation":"Low vision: BCVA worse than 20/40 in the better eye after best correction. Legal blindness: BCVA ≤20/200 or visual field ≤20° in the better eye.","source":"ABO: Low Vision — Definitions & Classification"},
  {"domain":"low_vision","difficulty":"intermediate","question":"Patient with 20/200 BCVA needs to read 20/20 print. Required magnification:","options":["2×","5×","10×","20×"],"correct":2,"explanation":"Magnification = denominator of current VA ÷ denominator of target VA = 200 ÷ 20 = 10×.","source":"ABO: Low Vision — Magnification Calculation"},
  {"domain":"low_vision","difficulty":"intermediate","question":"Eccentric viewing teaches patients to:","options":["Use only one eye for reading","Fixate off-center to use healthy retinal cells outside a central scotoma","Use a mirror to redirect images","Tilt reading material"],"correct":1,"explanation":"Eccentric viewing (EV): patients with central scotomas (e.g., AMD) learn to fixate with a Preferred Retinal Locus (PRL) — healthy peripheral retina adjacent to the scotoma.","source":"ABO: Low Vision — Eccentric Viewing & PRL"},
  {"domain":"low_vision","difficulty":"intermediate","question":"Patient with 20/100 BCVA reading at 40 cm. Required add power:","options":["+2.50 D","+5.00 D","+10.00 D","+12.50 D"],"correct":3,"explanation":"Step 1: Magnification needed = 100/20 = 5×. Step 2: Base add for 40cm = 1/0.40 = +2.50D. Step 3: Total add = 5 × 2.50 = +12.50 D.","source":"ABO: Low Vision — Reading Add Calculation"}
]
</script>
<script>
(function(){
"use strict";
var DM={geometric_optics:{l:"Geometric Optics",i:"&#128302;"},ophthalmic_optics:{l:"Ophthalmic Optics",i:"&#128301;"},lens_materials:{l:"Lens Materials",i:"&#128142;"},lens_designs:{l:"Lens Designs",i:"&#128083;"},coatings:{l:"Coatings",i:"&#10024;"},frame_selection:{l:"Frame Selection",i:"&#128246;"},measurements:{l:"Measurements",i:"&#128208;"},dispensing:{l:"Dispensing",i:"&#128295;"},prescriptions:{l:"Prescriptions",i:"&#128203;"},anatomy:{l:"Ocular Anatomy",i:"&#129514;"},pathology:{l:"Ocular Pathology",i:"&#127973;"},contact_lenses:{l:"Contact Lenses",i:"&#128065;"},regulations:{l:"Regulations",i:"&#9878;"},safety_eyewear:{l:"Safety Eyewear",i:"&#129366;"},low_vision:{l:"Low Vision",i:"&#128270;"}};
var DIFF_L={mixed:"Mixed",foundation:"Foundational",intermediate:"Intermediate",advanced:"Advanced",expert:"Expert",calculations:"Calc-Focused"};
var LTR=["A","B","C","D","E"];

var GROQ_URL="https://api.groq.com/openai/v1/chat/completions";
var OR_URL="https://openrouter.ai/api/v1/chat/completions";

var THEMES=[
  {id:"",label:"Deep Ocean",colors:["#080c16","#63b3ed","#d4a853"]},
  {id:"theme-emerald",label:"Emerald",colors:["#081610","#48bb78","#d4a853"]},
  {id:"theme-crimson",label:"Crimson",colors:["#160810","#f56565","#d4a853"]},
  {id:"theme-violet",label:"Violet",colors:["#0d0816","#9f7aea","#d4a853"]},
  {id:"theme-clinical",label:"Clinical",colors:["#f0f4f8","#3182ce","#c27c1a"]},
  {id:"theme-slate",label:"Slate",colors:["#0f1117","#a0aec0","#d4a853"]}
];

var BANK=JSON.parse(document.getElementById("bank-data").textContent);

// State
var offline=true, provider="groq", selModel="llama-3.3-70b-versatile";
var selDomain="all", selDiff="mixed", selCount=10, explainMode="immediate";
var examMode="practice", timedMode=false, shuffleMode=true, timerDuration=60;
var showDomainTag=true, showDiffTag=true;
var questions=[], qi=0, score=0, wrongs=0, results=[], qStart=0, totalTime=0;
var timerIv=null, timerLeft=60, answered=false;
var groqKey="", orKey="";

function el(id){return document.getElementById(id);}
function showPage(id){["pg-setup","pg-prog","pg-appear","pg-quiz","pg-results"].forEach(function(p){el(p).classList.remove("show");});el(id).classList.add("show");}
function toast(msg,good){var t=el("toast");t.textContent=msg;t.style.borderColor=good===true?"rgba(104,211,145,.35)":good===false?"rgba(252,129,129,.25)":"var(--bdr)";t.classList.add("show");clearTimeout(t._t);t._t=setTimeout(function(){t.classList.remove("show");},2200);}
function shuffle(arr){var a=arr.slice();for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=a[i];a[i]=a[j];a[j]=tmp;}return a;}
function shuffleQ(q){var pairs=q.options.map(function(o,i){return{o:o,ok:i===q.correct};});pairs=shuffle(pairs);var nq=JSON.parse(JSON.stringify(q));nq.options=pairs.map(function(p){return p.o;});nq.correct=pairs.findIndex(function(p){return p.ok;});return nq;}

// Load saved keys and theme
try{
  groqKey=localStorage.getItem("abo_gk")||"";
  orKey=localStorage.getItem("abo_ok")||"";
  if(groqKey){el("key-groq").value=groqKey;setApiStatus("status-groq","&#10003; Key loaded","ok");}
  if(orKey){el("key-or").value=orKey;setApiStatus("status-or","&#10003; Key loaded","ok");}
  var savedTheme=localStorage.getItem("abo_theme")||"";
  applyTheme(savedTheme,true);
}catch(e){}

// Build theme swatches
(function(){
  var sc=el("theme-swatches");
  THEMES.forEach(function(t){
    var item=document.createElement("div");
    item.style.cssText="display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;";
    var swatch=document.createElement("div");
    swatch.className="theme-swatch"+(t.id===(localStorage.getItem("abo_theme")||"")?" on":"");
    swatch.style.cssText="width:42px;height:42px;border-radius:50%;cursor:pointer;border:3px solid "+(swatch.classList.contains("on")?"var(--tx)":"transparent")+";transition:.2s;background:linear-gradient(135deg,"+t.colors[0]+" 40%,"+t.colors[1]+" 100%);";
    var lbl=document.createElement("div");
    lbl.style.cssText="font-size:10px;color:var(--tx2);font-family:'DM Mono',monospace;text-align:center;";
    lbl.textContent=t.label;
    item.appendChild(swatch);item.appendChild(lbl);
    item.addEventListener("click",function(){applyTheme(t.id);});
    sc.appendChild(item);
  });
})();

function applyTheme(id,skipSave){
  document.body.className=id;
  try{if(!skipSave)localStorage.setItem("abo_theme",id);}catch(e){}
  var swatches=document.querySelectorAll(".theme-swatch");
  swatches.forEach(function(s,i){
    var isOn=THEMES[i].id===id;
    s.classList.toggle("on",isOn);
    s.style.border="3px solid "+(isOn?"var(--tx)":"transparent");
  });
}

// API status
function setApiStatus(elId,msg,cls){var s=el(elId);s.innerHTML=msg;s.className="api-status "+(cls||"");}

// Save keys
el("save-groq").addEventListener("click",function(){
  var k=el("key-groq").value.trim();
  if(!k){setApiStatus("status-groq","Please paste your Groq key","err");return;}
  groqKey=k;try{localStorage.setItem("abo_gk",k);}catch(e){}
  setApiStatus("status-groq","&#10003; Saved!","ok");toast("Groq key saved",true);
});
el("save-or").addEventListener("click",function(){
  var k=el("key-or").value.trim();
  if(!k){setApiStatus("status-or","Please paste your OpenRouter key","err");return;}
  orKey=k;try{localStorage.setItem("abo_ok",k);}catch(e){}
  setApiStatus("status-or","&#10003; Saved!","ok");toast("OpenRouter key saved",true);
});
el("key-groq").addEventListener("keydown",function(e){if(e.key==="Enter")el("save-groq").click();});
el("key-or").addEventListener("keydown",function(e){if(e.key==="Enter")el("save-or").click();});

// Mode toggle
el("mode-chk").addEventListener("change",function(){
  offline=!this.checked;
  el("lbl-off").classList.toggle("active",offline);
  el("lbl-ai").classList.toggle("active",!offline);
  el("mode-label").textContent=offline?"Offline Bank":"AI Generated";
  el("mode-sub").textContent=offline?"90+ verified questions — works without internet":"Fresh unique questions from your chosen AI model";
  el("ai-panel").classList.toggle("show",!offline);
});

// Provider switch
el("prov-groq").addEventListener("click",function(){
  provider="groq";
  el("prov-groq").classList.add("on");el("prov-or").classList.remove("on");
  el("ms-groq").classList.add("show");el("ms-or").classList.remove("show");
  var on=document.querySelector("#ml-groq .mc.on");
  selModel=on?on.getAttribute("data-mid"):"llama-3.3-70b-versatile";
});
el("prov-or").addEventListener("click",function(){
  provider="openrouter";
  el("prov-or").classList.add("on");el("prov-groq").classList.remove("on");
  el("ms-or").classList.add("show");el("ms-groq").classList.remove("show");
  var on=document.querySelector("#ml-or .mc.on");
  selModel=on?on.getAttribute("data-mid"):"meta-llama/llama-3.3-70b-instruct:free";
});

// Model selection (event delegation)
["ml-groq","ml-or"].forEach(function(listId){
  el(listId).addEventListener("click",function(e){
    var mc=e.target.closest(".mc");
    if(!mc)return;
    el(listId).querySelectorAll(".mc").forEach(function(c){c.classList.remove("on");});
    mc.classList.add("on");
    selModel=mc.getAttribute("data-mid");
  });
});

// Domain buttons
var dbtns=document.querySelectorAll("#domain-grid .dbtn");
dbtns.forEach(function(btn){btn.addEventListener("click",function(){dbtns.forEach(function(b){b.classList.remove("on");});btn.classList.add("on");selDomain=btn.getAttribute("data-d");});});

// Difficulty buttons
var dfbtns=document.querySelectorAll("#diff-grid .dfbtn");
dfbtns.forEach(function(btn){btn.addEventListener("click",function(){dfbtns.forEach(function(b){b.classList.remove("on");});btn.classList.add("on");selDiff=btn.getAttribute("data-df");});});

// Segmented controls
function wireSeg(id,cb){var btns=document.querySelectorAll("#"+id+" .sgbtn");btns.forEach(function(btn){btn.addEventListener("click",function(){btns.forEach(function(b){b.classList.remove("on");});btn.classList.add("on");cb(btn.getAttribute("data-v"));});});}
wireSeg("seg-explain",function(v){explainMode=v;});
wireSeg("seg-exammode",function(v){
  examMode=v;
  el("exammode-desc").textContent=v==="practice"?"Live score shown":"Score hidden until end";
  el("live-wrap").style.visibility=v==="practice"?"visible":"hidden";
});

// Range sliders
el("rng-count").addEventListener("input",function(){selCount=parseInt(this.value,10);el("rv-count").textContent=this.value;});
el("rng-timer").addEventListener("input",function(){timerDuration=parseInt(this.value,10);el("rv-timer").textContent=this.value+"s";});

// Toggle settings
function wireTog(chkId,stateId,cb){
  el(chkId).addEventListener("change",function(){
    var on=this.checked;
    el(stateId).textContent=on?"On":"Off";
    el(stateId).classList.toggle("on",on);
    cb(on);
  });
}
wireTog("chk-timer","timer-state",function(v){timedMode=v;});
wireTog("chk-shuffle","shuffle-state",function(v){shuffleMode=v;});
wireTog("chk-dtag","dtag-state",function(v){showDomainTag=v;});
wireTog("chk-dftag","dftag-state",function(v){showDiffTag=v;});

// Navigation
function gotoSetup(){showPage("pg-setup");["t-setup","t-setup2","t-setup3"].forEach(function(id){var e=el(id);if(e){e.classList.toggle("on",id==="t-setup");}});}
function gotoProg(){showPage("pg-prog");renderProgress();}
function gotoAppear(){showPage("pg-appear");}

["t-setup","t-setup2","t-setup3"].forEach(function(id){var e=el(id);if(e)e.addEventListener("click",gotoSetup);});
["t-prog","t-prog2","t-prog3"].forEach(function(id){var e=el(id);if(e)e.addEventListener("click",gotoProg);});
["t-appear","t-appear2","t-appear3"].forEach(function(id){var e=el(id);if(e)e.addEventListener("click",gotoAppear);});

el("btn-start").addEventListener("click",function(){startQuiz(null);});
el("btn-next").addEventListener("click",nextQ);
el("btn-new").addEventListener("click",gotoSetup);
el("btn-retry").addEventListener("click",function(){
  startQuiz(results.filter(function(r){return!r.ok;}).map(function(r){return JSON.parse(JSON.stringify(r.q));}));
});
el("btn-clear").addEventListener("click",function(){
  if(!confirm("Reset ALL saved progress and session history?\nThis cannot be undone."))return;
  try{localStorage.removeItem("abo5");}catch(e){}
  renderProgress();toast("Progress reset",true);
});

// Keyboard shortcuts
document.addEventListener("keydown",function(e){
  if(!el("pg-quiz").classList.contains("show"))return;
  if(el("next-row").style.display!=="none"){if(e.key===" "||e.key==="ArrowRight"){e.preventDefault();nextQ();}}
  else{var map={"1":0,"2":1,"3":2,"4":3,"5":4,"a":0,"b":1,"c":2,"d":3,"e":4};var k=map[e.key.toLowerCase()];if(k!==undefined)selectAnswer(k);}
});

// Build offline question pool
function buildPool(){
  var pool=BANK.slice();
  if(selDomain!=="all")pool=pool.filter(function(q){return q.domain===selDomain;});
  if(selDiff==="calculations"){var cd=["geometric_optics","ophthalmic_optics","prescriptions","measurements","low_vision"];pool=pool.filter(function(q){return cd.indexOf(q.domain)!==-1;});}
  else if(selDiff!=="mixed")pool=pool.filter(function(q){return q.difficulty===selDiff;});
  if(!pool.length)pool=BANK.slice();
  return shuffle(pool).slice(0,selCount);
}

// Start quiz
function startQuiz(retryPool){
  questions=[];qi=0;score=0;wrongs=0;results=[];totalTime=0;answered=false;
  clearTimer();showPage("pg-quiz");
  el("live-c").textContent="0";el("live-w").textContent="0";el("live-p").textContent="0/0";
  el("live-wrap").style.visibility=examMode==="practice"?"visible":"hidden";
  el("next-row").style.display="none";el("timer-row").style.display="none";el("prog-fill").style.width="0%";
  setCard('<div class="loading"><div class="spinner"></div><div class="load-txt">Loading questions&hellip;</div></div>');
  if(retryPool&&retryPool.length){questions=shuffleMode?retryPool.map(shuffleQ):retryPool;renderQ();return;}
  if(offline){var pool=buildPool();questions=shuffleMode?pool.map(shuffleQ):pool;renderQ();}
  else loadAI();
}

function setCard(html){el("qcard").innerHTML=html;}

// ═══ AI QUESTION GENERATION ═══
function buildPrompt(){
  var domText=selDomain==="all"?"covering all 15 ABO content domains (well-distributed)":"focused exclusively on: "+(DM[selDomain]?DM[selDomain].l:selDomain);
  var diffMap={
    mixed:"a realistic ABO exam distribution (30% foundation, 45% intermediate, 25% advanced/expert)",
    foundation:"foundational level only — definitions, recall, basic identification",
    intermediate:"intermediate level only — applied knowledge, clinical scenarios, moderate calculations",
    advanced:"advanced level only — complex multi-step scenarios, nuanced clinical situations",
    expert:"expert level only — subtle edge cases, exception conditions, rarely-tested nuance",
    calculations:"calculation-heavy questions only — Prentice's Rule, vergence, transposition, spherical equivalent, magnification, blank size, add power calculations"
  };

  var sysprompt="You are a certified ABO (American Board of Opticianry) exam question writer with expert-level knowledge of ophthalmic optics, dispensing, and the ABO Study Guide content. You write rigorously accurate multiple-choice exam questions for opticianry students preparing for the ABO certification exam.\n\nCRITICAL ACCURACY RULES:\n1. Every numerical value (indices, Abbe values, tolerances, formulas) must match the published ABO Study Guide and ANSI standards exactly.\n2. Key values to use: CR-39 n=1.498 Abbe=58; Polycarbonate n=1.586 Abbe=28-30; Trivex n=1.53 Abbe=43-45; Crown glass n=1.523; High-index 1.67/1.70/1.74.\n3. ANSI Z80.1-2022 power tolerance: ±0.12D for powers ≤±6.50D; ±2% for higher powers.\n4. Axis tolerances: >1.50D cyl = ±2°; 0.75-1.50D = ±3°; 0.50D = ±5°; ≤0.25D = ±7°; ≤0.12D = ±14°.\n5. Prentice's Rule: P(prism diopters) = F(diopters) × d(centimeters). Base direction: plus lens displaced below OC = BU; above OC = BD; nasal = BI; temporal = BO. Minus lens: opposite.\n6. Transposition: new sphere = old sphere + old cylinder; new cylinder = opposite sign; new axis = old axis ±90.\n7. Spherical equivalent = sphere + (cylinder/2).\n8. Vertex distance: 12-14mm standard; clinically significant when Rx >±4.00D.\n9. FDA drop ball: 5/8-inch ball from 50 inches (21 CFR 801.410).\n10. Standard bifocal: FT-28mm is most common. PAL: near zone at bottom, distance at top.\n\nQUESTION WRITING RULES:\n- Each question must have exactly 4 answer options.\n- Only one correct answer per question.\n- All distractors must be clinically plausible (not obviously wrong).\n- Include a mix of question types: factual recall, application, calculation, clinical scenario.\n- Explanations must cite the specific rule, formula, or standard being tested.\n- The 'source' field must reference the specific ABO domain and topic.\n- No two questions may test the same fact.\n- Vary the position of the correct answer (A, B, C, D) — do not default to always making it B.\n\nReturn ONLY valid compact JSON, no markdown, no commentary, no thinking text:\n{\"questions\":[{\"domain\":\"domain_key\",\"difficulty\":\"foundation|intermediate|advanced|expert\",\"question\":\"...\",\"options\":[\"A\",\"B\",\"C\",\"D\"],\"correct\":0,\"explanation\":\"...\",\"source\":\"ABO: Domain — Topic\"}]}";

  var userprompt="Generate exactly "+selCount+" ABO exam questions "+domText+", at "+( diffMap[selDiff]||diffMap.mixed)+" difficulty. Use these domain keys: geometric_optics, ophthalmic_optics, lens_materials, lens_designs, coatings, frame_selection, measurements, dispensing, prescriptions, anatomy, pathology, contact_lenses, regulations, safety_eyewear, low_vision. Ensure all numerical values are clinically accurate per the ABO Study Guide. Include at least one calculation question if possible. No duplicate topics.";

  return {system:sysprompt,user:userprompt};
}

function loadAI(){
  var key=provider==="groq"?groqKey:orKey;
  if(!key){
    showAIError("No API key for "+(provider==="groq"?"Groq":"OpenRouter")+". Go back to Setup and save your key.");
    return;
  }
  var p=buildPrompt();
  var url=provider==="groq"?GROQ_URL:OR_URL;
  var headers={"Content-Type":"application/json","Authorization":"Bearer "+key};
  if(provider==="openrouter"){headers["HTTP-Referer"]="https://abo-mock-exam.app";headers["X-Title"]="ABO Mock Exam";}

  var body={model:selModel,messages:[{role:"system",content:p.system},{role:"user",content:p.user}],temperature:0.6,max_tokens:8000};

  fetch(url,{method:"POST",headers:headers,body:JSON.stringify(body)})
  .then(function(r){
    if(!r.ok)return r.text().then(function(t){throw new Error(r.status+": "+t.slice(0,300));});
    return r.json();
  })
  .then(function(data){
    if(data.error)throw new Error(data.error.message||JSON.stringify(data.error));
    var content=data.choices&&data.choices[0]&&data.choices[0].message&&data.choices[0].message.content;
    if(!content)throw new Error("No content in API response");
    // Strip any chain-of-thought tags (DeepSeek R1 style)
    content=content.replace(/<think>[\s\S]*?<\/think>/g,"").trim();
    // Strip markdown fences
    content=content.replace(/```json|```/g,"").trim();
    var s=content.indexOf("{"),e=content.lastIndexOf("}");
    if(s===-1)throw new Error("No JSON found in response");
    var parsed=JSON.parse(content.slice(s,e+1));
    if(!parsed.questions||!parsed.questions.length)throw new Error("Empty questions array in response");
    questions=shuffleMode?parsed.questions.map(shuffleQ):parsed.questions;
    renderQ();
  })
  .catch(function(err){
    var isKey=err.message&&(err.message.indexOf("401")!==-1||err.message.indexOf("403")!==-1||err.message.indexOf("invalid_api_key")!==-1||err.message.indexOf("API_KEY")!==-1);
    showAIError(isKey?"Invalid or expired API key. Check your key at "+(provider==="groq"?"console.groq.com":"openrouter.ai")+".":err.message||"Unknown error");
  });
}

function showAIError(msg){
  setCard(
    '<div class="loading">'+
    '<div style="font-size:1.8rem">&#9888;&#65039;</div>'+
    '<div class="load-txt" style="color:var(--bad)">'+msg+'</div>'+
    '<br><div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">'+
    '<button class="btn-sec" id="btn-ai-back">&#8592; Back to Setup</button>'+
    '<button class="btn-go" id="btn-ai-fallback" style="width:auto;padding:11px 20px;margin-top:0">&#128266; Use Offline Bank</button>'+
    '</div></div>'
  );
  el("btn-ai-back").addEventListener("click",gotoSetup);
  el("btn-ai-fallback").addEventListener("click",function(){
    offline=true;el("mode-chk").checked=false;
    el("lbl-off").classList.add("active");el("lbl-ai").classList.remove("active");
    el("mode-label").textContent="Offline Bank";el("mode-sub").textContent="90+ verified questions — works without internet";
    el("ai-panel").classList.remove("show");
    score=0;wrongs=0;results=[];qi=0;totalTime=0;answered=false;
    el("live-c").textContent="0";el("live-w").textContent="0";el("live-p").textContent="0/0";
    el("next-row").style.display="none";el("timer-row").style.display="none";
    questions=shuffleMode?buildPool().map(shuffleQ):buildPool();renderQ();
  });
}

// Render question
function renderQ(){
  clearTimer();answered=false;
  if(qi>=questions.length){showResults();return;}
  var q=questions[qi];
  el("prog-fill").style.width=(qi/questions.length*100)+"%";
  var meta=DM[q.domain]||{l:q.domain,i:"&#128208;"};
  var dcMap={foundation:"f",intermediate:"i",advanced:"a",expert:"e"};
  var dlMap={foundation:"Foundational",intermediate:"Intermediate",advanced:"Advanced",expert:"Expert"};
  var srcTag=offline?'<span class="qtag qt-off">Offline</span>':'<span class="qtag qt-ai">AI: '+selModel.split("/").pop().replace(/:free$/,"")+'</span>';
  var domTag=showDomainTag?'<span class="qtag qt-d">'+meta.l+'</span>':"";
  var diffTag=showDiffTag?'<span class="qtag qt-'+(dcMap[q.difficulty]||"f")+'">'+(dlMap[q.difficulty]||q.difficulty)+'</span>':"";

  var optsH=q.options.map(function(o,i){
    return'<button class="opt" data-idx="'+i+'"><span class="opt-l">'+LTR[i]+'</span><span style="flex:1">'+o+'</span><span class="opt-k">'+(i+1)+'</span></button>';
  }).join("");

  setCard(
    '<div class="qmeta"><div class="qnum">Question '+(qi+1)+' / '+questions.length+'</div>'+
    '<div class="qtags">'+domTag+diffTag+srcTag+'</div></div>'+
    '<div class="qtext">'+q.question+'</div>'+
    '<div class="opts" id="opts-c">'+optsH+'</div>'+
    '<div class="exp" id="expbox"><div class="exp-lbl">Explanation</div><div class="exp-body">'+q.explanation+'</div><div class="exp-src">'+(q.source||"")+'</div></div>'
  );

  document.getElementById("opts-c").addEventListener("click",function(e){
    var b=e.target.closest(".opt");if(b)selectAnswer(parseInt(b.getAttribute("data-idx"),10));
  });
  el("next-row").style.display="none";
  qStart=Date.now();
  if(timedMode){timerLeft=timerDuration;el("timer-row").style.display="flex";startTimer();}
}

// Timer
function startTimer(){
  updateTimer();
  timerIv=setInterval(function(){timerLeft--;updateTimer();if(timerLeft<=0){clearTimer();onTimeout();}},1000);
}
function updateTimer(){
  var r=timerLeft<=10;
  el("tnum").textContent=timerLeft;el("tnum").className="tnum"+(r?" red":"");
  el("tbar-fill").style.width=(timerLeft/timerDuration*100)+"%";
  el("tbar-fill").className="tbar-fill"+(r?" red":"");
}
function clearTimer(){clearInterval(timerIv);timerIv=null;}
function onTimeout(){
  if(answered)return;answered=true;toast("Time's up!");
  el("qcard").querySelectorAll(".opt").forEach(function(o){o.disabled=true;if(parseInt(o.getAttribute("data-idx"),10)===questions[qi].correct)o.classList.add("missed");});
  record(-1,false);
  if(explainMode==="immediate"){var e=el("expbox");if(e)e.classList.add("show");}
  el("next-row").style.display="flex";
}

// Select answer
function selectAnswer(i){
  if(answered)return;answered=true;clearTimer();
  var q=questions[qi],isOk=i===q.correct;
  el("qcard").querySelectorAll(".opt").forEach(function(o){
    o.disabled=true;
    var idx=parseInt(o.getAttribute("data-idx"),10);
    if(idx===q.correct)o.classList.add("ok");else if(idx===i)o.classList.add("bad");
  });
  toast(isOk?"Correct! \u2713":"Incorrect",isOk);
  record(i,isOk);
  if(explainMode==="immediate"){var e=el("expbox");if(e)e.classList.add("show");}
  el("next-row").style.display="flex";
}

function record(ans,isOk){
  var t=(Date.now()-qStart)/1000;totalTime+=t;
  if(isOk)score++;else wrongs++;
  results.push({q:questions[qi],ans:ans,ok:isOk,time:t});
  el("live-c").textContent=score;el("live-w").textContent=wrongs;
  el("live-p").textContent=(score+wrongs)+"/"+questions.length;
}
function nextQ(){qi++;renderQ();}

// Show results
function showResults(){
  clearTimer();showPage("pg-results");
  var total=results.length,pct=total?Math.round(score/total*100):0;
  var avgT=total?(totalTime/total).toFixed(1)+"s":"-";
  // Reveal score in exam mode
  if(examMode==="exam"){el("live-wrap").style.visibility="visible";}
  var col=pct>=75?"var(--ok)":pct>=55?"var(--wrn)":"var(--bad)";
  el("result-ring").style.background="conic-gradient("+col+" "+(pct*3.6)+"deg,var(--s2) 0)";
  el("ring-num").textContent=pct+"%";el("ring-num").style.color=col;
  el("rs-c").textContent=score;el("rs-w").textContent=total-score;el("rs-t").textContent=total;el("rs-time").textContent=avgT;

  var msgs=[[90,"Exceptional","Outstanding! Well-prepared for the ABO."],[75,"Strong Pass","You would pass the ABO. Keep reviewing weak domains."],[60,"Almost There","ABO requires 75%. Keep studying!"],[0,"Needs Work","Review core ABO domains and keep practicing."]];
  var msg=msgs.find(function(m){return pct>=m[0];});
  el("res-title").textContent=msg[1];el("res-sub").textContent=msg[2];

  // Domain breakdown
  var ds={};
  results.forEach(function(r){var d=r.q.domain||"unknown";if(!ds[d])ds[d]={c:0,t:0};ds[d].t++;if(r.ok)ds[d].c++;});
  el("res-doms").innerHTML=Object.keys(ds).map(function(d){
    var v=ds[d],p=Math.round(v.c/v.t*100),m=DM[d]||{l:d,i:""};
    var c=p>=75?"var(--ok)":p>=50?"var(--wrn)":"var(--bad)";
    return'<div class="dom-row"><div class="dom-icon">'+m.i+'</div><div class="dom-info"><div class="dom-name">'+m.l+'</div><div class="dom-bar"><div class="dom-fill" style="width:'+p+'%;background:'+c+'"></div></div><div class="dom-stat">'+v.c+'/'+v.t+' correct</div></div><div class="dom-pct" style="color:'+c+'">'+p+'%</div></div>';
  }).join("");

  // Reveal explanations at-end mode
  el("rev-list").innerHTML=results.map(function(r,idx){
    var cls=r.ok?"ok":"bad";
    var wl=r.ans===-1?'<div class="rev-ans w">Timed out</div>':(!r.ok?'<div class="rev-ans w">Your answer: '+r.q.options[r.ans]+'</div>':"");
    var expHtml=explainMode!=="never"?'<div class="rev-exp">'+r.q.explanation+'</div><div class="rev-src">'+(r.q.source||"")+"</div>":'';
    return'<div class="rev-item '+cls+'">'+
      '<div class="rev-hdr"><span class="rev-icon">'+(r.ok?"&#10003;":"&#10007;")+'</span><span class="rev-q">Q'+(idx+1)+'. '+r.q.question+'</span><span class="rev-chev">&#9660;</span></div>'+
      '<div class="rev-body">'+wl+'<div class="rev-ans c">Correct: '+r.q.options[r.q.correct]+'</div>'+expHtml+'<div style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--mut);margin-top:5px;">'+r.time.toFixed(1)+'s</div></div>'+
    '</div>';
  }).join("");
  el("rev-list").querySelectorAll(".rev-item").forEach(function(item){
    item.querySelector(".rev-hdr").addEventListener("click",function(){item.classList.toggle("open");});
  });
  el("btn-retry").style.display=results.some(function(r){return!r.ok;})?"block":"none";
  saveSession(pct,score,total,ds);
}

// Storage
function getStore(){try{return JSON.parse(localStorage.getItem("abo5")||'{"sessions":[],"ds":{}}');}catch(e){return{sessions:[],ds:{}};}}
function saveSession(pct,correct,total,domBreak){
  var s=getStore();
  s.sessions.unshift({pct:pct,correct:correct,total:total,domain:selDomain,diff:selDiff,mode:offline?"offline":provider+"/"+selModel.split("/").pop().replace(/:free$/,""),date:new Date().toLocaleDateString()});
  if(s.sessions.length>30)s.sessions=s.sessions.slice(0,30);
  Object.keys(domBreak).forEach(function(d){var v=domBreak[d];if(!s.ds[d])s.ds[d]={c:0,t:0};s.ds[d].c+=v.c;s.ds[d].t+=v.t;});
  try{localStorage.setItem("abo5",JSON.stringify(s));}catch(e){}
}

// Progress page
function renderProgress(){
  var store=getStore(),ses=store.sessions,ds=store.ds;
  var tc=ses.reduce(function(a,x){return a+x.correct;},0),tt=ses.reduce(function(a,x){return a+x.total;},0);
  var op=tt?Math.round(tc/tt*100):0,best=ses.length?Math.max.apply(null,ses.map(function(x){return x.pct;})):0;
  var rec=ses.slice(0,5),ravg=rec.length?Math.round(rec.reduce(function(a,x){return a+x.pct;},0)/rec.length):0;
  var passes=ses.filter(function(x){return x.pct>=75;}).length;

  el("stat-grid").innerHTML=!ses.length
    ?'<div class="nodata" style="grid-column:1/-1">No sessions yet — start your first exam!</div>'
    :[
      ["var(--acc)",ses.length,"Sessions"],
      [op>=75?"var(--ok)":"var(--bad)",op+"%","Overall Acc."],
      ["var(--wrn)",best+"%","Best Score"],
      [ravg>=75?"var(--ok)":"var(--bad)",ravg+"%","Recent Avg"],
      ["var(--ok)",passes,"Passes (75%+)"],
      ["var(--acc)",tt,"Total Qs"]
    ].map(function(b){
      return'<div class="stat-box"><div class="stat-val" style="color:'+b[0]+'">'+b[1]+'</div><div class="stat-lbl">'+b[2]+'</div></div>';
    }).join("");

  var dk=Object.keys(ds);
  el("prog-doms").innerHTML=!dk.length
    ?'<div class="nodata">Complete exams to see domain performance</div>'
    :dk.sort(function(a,b){return(ds[a].c/ds[a].t)-(ds[b].c/ds[b].t);}).map(function(d){
        var v=ds[d],p=Math.round(v.c/v.t*100),m=DM[d]||{l:d,i:""};
        var c=p>=75?"var(--ok)":p>=50?"var(--wrn)":"var(--bad)";
        return'<div class="dom-row"><div class="dom-icon">'+m.i+'</div><div class="dom-info"><div class="dom-name">'+m.l+'</div><div class="dom-bar"><div class="dom-fill" style="width:'+p+'%;background:'+c+'"></div></div><div class="dom-stat">'+v.c+'/'+v.t+' correct (cumulative)</div></div><div class="dom-pct" style="color:'+c+'">'+p+'%</div></div>';
      }).join("");

  el("ses-list").innerHTML=!ses.length
    ?'<div class="nodata">No sessions yet</div>'
    :ses.slice(0,15).map(function(s){
        var dl=s.domain==="all"?"All Domains":(DM[s.domain]?DM[s.domain].l:s.domain);
        return'<div class="ses-item">'+
          '<div class="ses-pct '+(s.pct>=75?"p":"f")+'">'+s.pct+'%</div>'+
          '<div class="ses-det">'+s.correct+'/'+s.total+' &mdash; '+dl+' &mdash; '+(DIFF_L[s.diff]||s.diff)+' &mdash; '+s.mode+'</div>'+
          '<div class="ses-date">'+s.date+'</div>'+
        '</div>';
      }).join("");
}

})();
</script>
</body>
</html>
